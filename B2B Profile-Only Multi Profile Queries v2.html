<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    /* Adobe-inspired palette and global styles */
    :root {
        --adobe-blue: #0265dc;
        --adobe-blue-hover: #0052b3;
        --adobe-gray-50: #fafafa;
        --adobe-gray-100: #f4f4f4;
        --adobe-gray-200: #eaeaea;
        --adobe-gray-300: #e3e3e3;
        --adobe-gray-400: #d3d3d3;
        --adobe-gray-500: #cacaca;
        --adobe-gray-600: #b2b2b2;
        --adobe-gray-700: #8e8e8e;
        --adobe-gray-800: #505050;
        --adobe-gray-900: #323232;
        --text-color: #4b4b4b;
        --metric-color: #e67e22;
        --dim-color: #0c84e8;
        --system-color: #6c757d;
        --radio-checked-color: var(--adobe-blue);
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background-color: var(--adobe-gray-100);
        color: var(--text-color);
        margin: 0;
        padding: 0;
    }
    .preview-container {
        max-width: 1400px;
        margin: 20px auto;
        background: #fff;
        border: 1px solid var(--adobe-gray-300);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    
    /* Main Tab Navigation */
    .main-tab-bar {
        display: flex;
        background-color: var(--adobe-gray-50);
        border-bottom: 1px solid var(--adobe-gray-300);
        padding: 0 20px;
    }
    .main-tab-link {
        padding: 16px 20px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        font-weight: 600;
        color: var(--adobe-gray-700);
        font-size: 16px;
        transition: all 0.2s ease;
        margin-right: 10px;
    }
    .main-tab-link:hover {
        background-color: var(--adobe-gray-100);
        color: var(--adobe-blue);
    }
    .main-tab-link.active {
        border-bottom-color: var(--adobe-blue);
        color: var(--adobe-blue);
        background-color: #fff;
    }
    .main-tab-content {
        padding: 25px;
        min-height: 650px;
    }
    .main-tab-pane {
        display: none;
    }
    .main-tab-pane.active {
        display: block;
    }

    /* General Content Styling */
    h2 {
        color: #000;
        border-bottom: 1px solid var(--adobe-gray-200);
        padding-bottom: 10px;
        margin-top: 0;
        font-size: 24px;
        font-weight: 400;
    }
    h3 {
        color: var(--adobe-gray-900);
        margin-top: 25px;
        margin-bottom: 10px;
        font-size: 18px;
        font-weight: 600;
    }
    p, li {
        font-size: 16px;
        line-height: 1.6;
    }
    code {
        background-color: #eef;
        padding: 3px 6px;
        border-radius: 4px;
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    }
    .info-box {
        background-color: #f4f8ff;
        border: 1px solid #c9ddff;
        border-left: 4px solid var(--adobe-blue);
        padding: 15px 20px;
        margin: 20px 0;
        border-radius: 5px;
    }
    .info-box strong {
        color: #0056b3;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border: 1px solid var(--adobe-gray-300);
        border-radius: 6px;
        overflow: hidden;
    }
    th, td {
        border-bottom: 1px solid var(--adobe-gray-300);
        padding: 12px 15px;
        text-align: left;
    }
    th {
        background-color: var(--adobe-gray-50);
        font-weight: 600;
        font-size: 14px;
    }
    tbody tr:last-child th,
    tbody tr:last-child td {
        border-bottom: none;
    }
    tr:nth-child(even) {
        background-color: var(--adobe-gray-50);
    }

    /* Spectrum-like Button */
    .button {
        padding: 8px 16px;
        font-size: 15px;
        font-weight: 600;
        border-radius: 16px; /* Pill shape */
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
        line-height: 1.5;
    }
    .button-primary {
        background-color: var(--adobe-blue);
        color: #fff;
        border-color: var(--adobe-blue);
    }
    .button-primary:hover { 
        background-color: var(--adobe-blue-hover); 
        border-color: var(--adobe-blue-hover);
    }
    .button-secondary {
        background-color: #fff;
        color: var(--adobe-gray-800);
        border-color: var(--adobe-gray-400);
    }
    .button-secondary:hover { 
        background-color: var(--adobe-gray-100);
        border-color: var(--adobe-gray-600);
    }

    /* --- Tab 3: Connection Setup --- */
    .connection-container {
        border: 1px solid var(--adobe-gray-400);
        border-radius: 6px;
        background: #fff;
        min-height: 600px;
    }
    .connection-header {
        padding: 12px 20px;
        background: var(--adobe-gray-50);
        border-bottom: 1px solid var(--adobe-gray-300);
    }
    .connection-header h2 {
        font-size: 20px;
        font-weight: 600;
        margin: 0;
        padding: 0;
        border: none;
        color: var(--adobe-gray-900);
    }
    .connection-body {
        display: flex;
    }
    .connection-left-nav {
        width: 250px;
        border-right: 1px solid var(--adobe-gray-300);
        padding: 20px 0;
        background: var(--adobe-gray-50);
    }
    .connection-nav-item {
        padding: 12px 20px;
        font-weight: 500;
        color: var(--adobe-gray-800);
        cursor: pointer;
        border-left: 3px solid transparent;
    }
    .connection-nav-item:hover {
        background: var(--adobe-gray-100);
        color: var(--adobe-blue);
    }
    .connection-nav-item.active {
        background: #fff;
        color: var(--adobe-blue);
        border-left-color: var(--adobe-blue);
        font-weight: 600;
    }
    .connection-main {
        flex: 1;
        padding: 25px;
        overflow-x: auto; /* Added for smaller screens */
    }
    .connection-main h3 {
        font-size: 20px;
        font-weight: 600;
        margin-top: 0;
    }
    .dataset-card {
        border: 1px solid var(--adobe-gray-400);
        border-radius: 6px;
        margin-bottom: 20px;
    }
    .dataset-card-header {
        padding: 15px 20px;
        background: var(--adobe-gray-50);
        border-bottom: 1px solid var(--adobe-gray-300);
        font-weight: 600;
    }
    .dataset-card-body {
        padding: 20px;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 8px;
    }
    .form-group select, .form-group input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--adobe-gray-400);
        border-radius: 4px;
        box-sizing: border-box; 
        font-size: 15px;
    }
    
    /* Connection Join UI */
    .join-pair-card {
        border: 1px solid var(--adobe-gray-300);
        border-radius: 6px;
        margin-top: 20px;
        background: #fff;
    }
    .join-pair-header {
        padding: 10px 20px;
        background: var(--adobe-gray-100);
        border-bottom: 1px solid var(--adobe-gray-300);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap; /* Added for responsiveness */
    }
    .join-pair-header h4 {
        margin: 0;
        font-size: 16px;
    }
    .path-name-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .path-name-group label {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 0; /* Override */
    }
    .path-name-group input {
        padding: 6px 10px;
        border-radius: 4px;
        border: 1px solid var(--adobe-gray-400);
        font-size: 14px;
        font-weight: 600;
        color: var(--adobe-blue);
        width: 200px;
    }
    .join-pair-body {
        padding: 25px;
    }
    .radio-group {
        margin-bottom: 20px;
    }
    .radio-group label {
        display: inline-block;
        margin-right: 20px;
        font-weight: 500;
        cursor: pointer;
        margin-bottom: 0; /* Override */
    }
    .radio-group input[type="radio"] {
        display: none;
    }
    .radio-group input[type="radio"] + .radio-label::before {
        content: '';
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 2px solid var(--adobe-gray-500);
        border-radius: 50%;
        margin-right: 8px;
        vertical-align: middle;
        transition: all 0.2s;
    }
    .radio-group input[type="radio"]:checked + .radio-label::before {
        border-color: var(--radio-checked-color);
        background-color: #fff;
        box-shadow: 0 0 0 4px #fff inset, 0 0 0 10px var(--radio-checked-color) inset;
    }
    .key-pair-row {
        display: flex;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap; /* Added for responsiveness */
    }
    .key-pair-col {
        flex: 1;
        min-width: 200px; /* Ensure dropdowns don't get too small */
    }

    /* --- Tab 4: Data View Config --- */
    .dv-container {
        border: 1px solid var(--adobe-gray-300);
        background: #fff;
        height: 700px;
        display: flex;
        flex-direction: column;
    }
    .dv-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 20px;
        border-bottom: 1px solid var(--adobe-gray-300);
        background: var(--adobe-gray-50);
        flex-wrap: wrap; /* Added for responsiveness */
    }
    .dv-header-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--adobe-gray-800);
    }
    .dv-header-title span {
        color: var(--adobe-gray-900);
        font-weight: 700;
    }
    .dv-header-buttons {
        display: flex;
        gap: 10px;
    }
    .dv-subnav {
        display: flex;
        padding: 0 20px;
        border-bottom: 1px solid var(--adobe-gray-300);
    }
    .dv-subnav-item {
        padding: 12px 16px;
        font-weight: 600;
        color: var(--adobe-gray-700);
        border-bottom: 3px solid transparent;
        cursor: pointer;
    }
    .dv-subnav-item.active {
        color: var(--adobe-blue);
        border-bottom-color: var(--adobe-blue);
    }
    .dv-body {
        display: flex;
        flex: 1;
        overflow: hidden;
        /* flex-wrap: wrap; <-- REMOVED THIS LINE. This was the bug. */
    }
    .dv-left-panel {
        width: 25%;
        border-right: 1px solid var(--adobe-gray-300);
        padding: 20px;
        overflow-y: auto;
        background: var(--adobe-gray-50);
        min-width: 250px; /* Ensure it's usable */
    }
    .dv-middle-panel {
        width: 45%;
        border-right: 1px solid var(--adobe-gray-300);
        overflow-y: auto;
        min-width: 300px; /* Ensure it's usable */
    }
    .dv-right-panel {
        width: 30%;
        overflow-y: auto;
        background: var(--adobe-gray-50);
        min-width: 250px; /* Ensure it's usable */
    }
    .dv-search-bar {
        position: relative;
        margin-bottom: 20px;
    }
    .dv-search-bar input {
        width: 100%;
        padding: 10px 10px 10px 35px;
        border-radius: 4px;
        border: 1px solid var(--adobe-gray-400);
        box-sizing: border-box;
    }
    .dv-search-bar svg {
        position: absolute;
        left: 10px;
        top: 11px;
        width: 16px;
        height: 16px;
        color: var(--adobe-gray-700);
    }
    .dv-dataset-group h4 {
        margin: 20px 0 10px;
        font-size: 14px;
        font-weight: 600;
        color: var(--adobe-gray-800);
        cursor: pointer;
        display: flex;
        align-items: center;
    }
    .dv-dataset-group h4::before {
        content: '►';
        font-size: 10px;
        margin-right: 8px;
        transition: transform 0.2s;
    }
    .dv-dataset-group.expanded h4::before {
        transform: rotate(90deg);
    }
    
    /* New Path Selection UI */
    .dv-path-selector {
        padding-left: 10px;
        margin-bottom: 15px;
        display: none; /* Hidden by default */
    }
    .dv-dataset-group.expanded .dv-path-selector {
        display: block; /* Show when group is open */
    }
    .dv-path-selector label {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 8px;
        display: block;
    }
    .dv-path-selector .radio-group {
        margin-bottom: 5px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .dv-path-selector .radio-group label {
        font-weight: 500;
        font-size: 15px;
        margin-right: 0;
        display: flex;
        align-items: center;
    }
    
    .dv-component-list {
        padding-left: 10px;
        background-color: #fff;
        border: 1px solid var(--adobe-gray-200);
        border-radius: 4px;
        padding: 8px;
        display: none; /* Hidden by default */
    }
    /* Show component list ONLY if a path is selected */
    .dv-path-selected .dv-component-list {
        display: block;
    }
    
    .dv-component-item {
        display: flex;
        align-items: center;
        padding: 8px;
        margin-bottom: 5px;
        border-radius: 4px;
    }
    .dv-component-item .icon {
        width: 24px;
        height: 24px;
        margin-right: 8px;
        flex-shrink: 0;
    }
    .dv-component-item .component-text {
        flex: 1;
        min-width: 0; /* Prevents text overflow issues */
    }
    .dv-component-item .component-name {
        font-weight: 500;
        font-size: 15px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .dv-add-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 1px solid var(--adobe-gray-400);
        background: #fff;
        color: var(--adobe-gray-700);
        font-size: 20px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 28px;
        transition: all 0.2s;
        flex-shrink: 0; /* Prevent button from shrinking */
    }
    .dv-add-btn:hover {
        border-color: var(--adobe-blue);
        color: var(--adobe-blue);
    }

    .dv-middle-panel table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
        border: none;
        box-shadow: none;
        border-radius: 0;
    }
    .dv-middle-panel th {
        font-size: 12px;
        font-weight: 600;
        color: var(--adobe-gray-700);
        text-transform: uppercase;
        padding: 10px 15px;
    }
    .dv-middle-panel td {
        padding: 12px 15px;
        font-size: 15px;
    }
    .dv-middle-panel tbody tr {
        cursor: pointer;
    }
    .dv-middle-panel tbody tr:hover {
        background: #f4f8ff;
    }
    .dv-middle-panel tbody tr.selected {
        background: #e6f2ff;
        border-left: 3px solid var(--adobe-blue);
    }
    .dv-middle-panel .icon {
        width: 20px;
        height: 20px;
        margin-right: 8px;
        vertical-align: middle;
    }
    .dv-middle-panel .component-name {
        font-weight: 500;
    }
    .dv-right-panel-placeholder {
        padding: 40px;
        text-align: center;
        color: var(--adobe-gray-700);
    }
    .dv-right-panel-placeholder svg {
        width: 60px;
        height: 60px;
        color: var(--adobe-gray-400);
        margin-bottom: 20px;
    }
    .dv-right-panel-settings {
        padding: 25px;
    }
    .dv-right-panel-settings h3 {
        font-size: 18px;
        font-weight: 600;
        margin-top: 0;
    }
    .dv-right-panel-settings .form-group label {
        font-size: 12px;
        text-transform: uppercase;
        color: var(--adobe-gray-700);
    }

    /* --- Tab 5: Workspace Analysis --- */
    .workspace-ui {
        background: var(--adobe-gray-100);
        border: 1px solid var(--adobe-gray-300);
        border-radius: 6px;
        padding: 20px;
    }
    .panel {
        background: #fff;
        border-radius: 6px;
        box-shadow: 0 3px 8px rgba(0,0,0,0.08);
        border: 1px solid var(--adobe-gray-300);
    }
    .panel-header {
        padding: 12px 20px;
        border-bottom: 1px solid var(--adobe-gray-200);
    }
    .panel-header .date-range {
        font-size: 14px;
        color: var(--adobe-gray-800);
        background: var(--adobe-gray-100);
        padding: 5px 10px;
        border-radius: 4px;
    }
    .panel-header .date-range strong {
        color: #c00;
        font-weight: 600;
    }
    .panel-body {
        padding: 20px;
        overflow-x: auto; /* Added for table responsiveness */
    }
    .panel-body table {
        border: none;
        box-shadow: none;
    }
    .panel-body table th {
        background-color: var(--adobe-gray-100);
    }
    .panel-body table th, .panel-body table td {
        text-align: right;
        padding: 14px;
    }
    .panel-body table th:first-child,
    .panel-body table td:first-child {
        text-align: left;
        font-weight: 600;
    }
    .panel-body table tr:last-child {
        background-color: var(--adobe-gray-100);
        font-weight: bold;
    }
    .panel-body table tr:last-child td,
    .panel-body table tr:last-child th {
        border-bottom: none;
    }
    .explanation {
        margin-top: 25px;
    }
    .explanation li {
        margin-bottom: 12px;
    }

    /* Helper Classes */
    .clickable {
        cursor: pointer;
    }
    .d-none {
        display: none !important;
    }

    /* SVG Icons */
    .icon-metric { color: var(--metric-color); }
    .icon-dim { color: var(--dim-color); }
    .icon-system { color: var(--system-color); }
</style>
</head>
<body>

<!-- SVGs for icons -->
<svg style="display:none;">
    <symbol id="icon-search" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></symbol>
    <symbol id="icon-metric" viewBox="0 0 24 24" fill="currentColor"><path d="M21 7.24V16.76C21 17.5 20.5 18 20 18H4C3.5 18 3 17.5 3 16.76V7.24C3 6.5 3.5 6 4 6H20C20.5 6 21 6.5 21 7.24ZM12 17C14.76 17 17 14.76 17 12S14.76 7 12 7 7 9.24 7 12 9.24 17 12 17Z"/></symbol>
    <symbol id="icon-dim" viewBox="0 0 24 24" fill="currentColor"><path d="M4 18h17v-6H4v6zM4 5v6h17V5H4z"/></symbol>
    <symbol id="icon-system" viewBox="0 0 24 24" fill="currentColor"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24" fill="currentColor"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-1.01l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.28-1.17.61-1.69 1.01l-2.49-1c-.23-.08-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19-.15-.24-.42-.12-.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69 1.01l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38 2.65c.61-.28 1.17-.61 1.69-1.01l2.49 1c.23.08.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></symbol>
</svg>

<div class="preview-container">
    <div class="main-tab-bar">
        <div class="main-tab-link active" onclick="openMainTab(event, 'tab-1')">1. Overview</div>
        <div class="main-tab-link" onclick="openMainTab(event, 'tab-2')">2. Datasets & Joins</div>
        <div class="main-tab-link" onclick="openMainTab(event, 'tab-3')">3. Connection Setup</div>
        <div class="main-tab-link" onclick="openMainTab(event, 'tab-4')">4. Data View Config</div>
        <div class="main-tab-link" onclick="openMainTab(event, 'tab-5')">5. Workspace Analysis</div>
    </div>

    <!-- ===== TAB 1: OVERVIEW ===== -->
    <div id="tab-1" class="main-tab-content main-tab-pane active">
        <h2>B2B Use Case: B2B Profile-Only - Multi Profile Queries</h2>
        <p>This prototype demonstrates a <strong>Profile-Only, Multi-Profile query</strong> for a CJA B2B Edition scenario.</p>
        
        <h3>Persona</h3>
        <p>A Sales Leadership team.</p>

        <h3>Use Case</h3>
        <p>The sales leadership team needs to understand the composition of their <em>entire</em> customer base to identify which accounts hold the most potential. They need to quantify the sales pipeline and organizational complexity for each account segment to prioritize resources for the upcoming fiscal year.</p>
        
        <h3>Business Question</h3>
        <p><strong>"What is the total number of open opportunities and distinct buying groups associated with each of our account tiers?"</strong></p>

        <div class="info-box">
            <strong>Key Concept: B2B Profile-Only - Multi-Profile Query</strong><br>
            This query is "Profile-Only" because it runs directly against the **Account Profile** dataset and its related lookups (Opportunities, Buying Groups). It is <strong>time-insensitive</strong> and ignores event data, allowing the sales team to analyze their *entire* portfolio, not just accounts that had web activity recently.
        </div>
    </div>

    <!-- ===== TAB 2: DATASETS & JOINS ===== -->
    <div id="tab-2" class="main-tab-content main-tab-pane">
        <h2>Datasets & Joins</h2>
        <p>To answer this question, we need a B2B connection with one primary profile dataset and two lookup datasets.</p>

        <h3>1. Account Lookup (Profile Dataset)</h3>
        <p>This is our primary <strong>Account</strong> dataset. It contains the master list of all customer accounts.</p>
        <table>
            <thead>
                <tr>
                    <th>account_id (Primary ID)</th>
                    <th>account_name</th>
                    <th>account_tier</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>A-100</td><td>Global Tech Inc.</td><td>Enterprise</td></tr>
                <tr><td>A-200</td><td>Innovate Solutions</td><td>Pro</td></tr>
                <tr><td>A-300</td><td>SMB Services</td><td>SMB</td></tr>
                <tr><td>A-400</td><td>Prospect Corp</td><td>Enterprise</td></tr>
            </tbody>
        </table>

        <h3>2. Opportunity Lookup (Lookup Dataset)</h3>
        <p>This lookup contains all sales opportunities, which will be joined to the Account dataset.</p>
        <table>
            <thead>
                <tr>
                    <th>opportunity_id (Primary Key)</th>
                    <th>account_id (Join Key)</th>
                    <th>opportunity_value</th>
                    <th>status</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>O-1001</td><td>A-100</td><td>500000</td><td>Open</td></tr>
                <tr><td>O-1002</td><td>A-100</td><td>250000</td><td>Closed-Won</td></tr>
                <tr><td>O-2001</td><td>A-200</td><td>100000</td><td>Open</td></tr>
                <tr><td>O-3001</td><td>A-300</td><td>50000</td><td>Open</td></tr>
                <tr><td>O-4001</td><td>A-400</td><td>1000000</td><td>Open</td></tr>
            </tbody>
        </table>

        <h3>3. Buying Group Lookup (Lookup Dataset)</h3>
        <p>This lookup contains all known buying groups, which will also be joined to the Account dataset.</p>
        <table>
            <thead>
                <tr>
                    <th>buying_group_id (Primary Key)</th>
                    <th>account_id (Join Key)</th>
                    <th>group_name</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>BG-111</td><td>A-100</td><td>IT Security</td></tr>
                <tr><td>BG-112</td><td>A-100</td><td>Data Science</td></tr>
                <tr><td>BG-222</td><td>A-200</td><td>Marketing</td></tr>
                <tr><td>BG-444</td><td>A-400</td><td>Executive</td></tr>
            </tbody>
        </table>

        <h3>Required Joins</h3>
        <p>To build our intended report, we need each lookup dataset to have **two separate join paths** defined in the Connection UI.</p>
        <ol>
            <li><strong>Opportunity Lookup Joins:</strong>
                <ul>
                    <li><strong>Path 1 (Event Join):</strong> `Match by container` ➔ `Opportunity`. This path is used to join `Event` data to this lookup.</li>
                    <li><strong>Path 2 (TPR Join):</strong> `Match by container` ➔ `Account`. This path is used to join this lookup to the `Account` profile for our report.</li>
                </ul>
            </li>
            <li><strong>Buying Group Lookup Joins:</strong>
                 <ul>
                    <li><strong>Path 1 (Event Join):</strong> `Match by container` ➔ `Buying Group`.</li>
                    <li><strong>Path 2 (TPR Join):</strong> `Match by container` ➔ `Account`.</li>
                </ul>
            </li>
        </ol>
        <div class="info-box">
            <strong>Critical Pathing Concept:</strong> The system needs separate, valid paths to get from `Account Tier` to *each* metric. The **TPR Join** paths (pointing to `Account`) are what make our Profile-Only query possible.
        </div>
    </div>

    <!-- ===== TAB 3: CONNECTION SETUP ===== -->
    <div id="tab-3" class="main-tab-content main-tab-pane">
        <div class="connection-container">
            <div class="connection-header">
                <h2>B2B Strategic Connection</h2>
            </div>
            <div class="connection-body">
                <div class="connection-left-nav">
                    <div class="connection-nav-item" onclick="switchConnectionTab(event, 'conn-tab-event')">Event datasets</div>
                    <div class="connection-nav-item" onclick="switchConnectionTab(event, 'conn-tab-profile')">Profile datasets</div>
                    <div class="connection-nav-item active" onclick="switchConnectionTab(event, 'conn-tab-lookup')">Lookup datasets</div>
                </div>
                <div class="connection-main">
                    <!-- Profile Datasets Pane -->
                    <div id="conn-tab-profile" class="connection-pane d-none">
                        <h3>Profile datasets</h3>
                        <div class="dataset-card">
                            <div class="dataset-card-header">Account Lookup</div>
                            <div class="dataset-card-body">
                                <div class="form-group">
                                    <label for="account-id">Account ID</label>
                                    <select id="account-id" disabled>
                                        <option selected>account_id</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Lookup Datasets Pane -->
                    <div id="conn-tab-lookup" class="connection-pane active">
                        <h3>Lookup datasets</h3>
                        
                        <!-- Opportunity Lookup Card -->
                        <div class="dataset-card">
                            <div class="dataset-card-header">Opportunity Lookup</div>
                            <div class="dataset-card-body">
                                
                                <!-- Key Pair 1: Event Join -->
                                <div class="join-pair-card">
                                    <div class="join-pair-header">
                                        <h4>Key pair #1</h4>
                                        <div class="path-name-group">
                                            <label for="path-name-opp-1">Path name:</label>
                                            <input type="text" id="path-name-opp-1" value="Event_Opportunity_Join">
                                        </div>
                                    </div>
                                    <div class="join-pair-body">
                                        <div class="radio-group">
                                            <label><input type="radio" name="match-method-opp-1" onclick="toggleOppJoinType(1, 'field')"> <span class="radio-label">Match by field</span></label>
                                            <label><input type="radio" name="match-method-opp-1" checked onclick="toggleOppJoinType(1, 'container')"> <span class="radio-label">Match by <strong>container</strong></span></label>
                                        </div>
                                        <div class="key-pair-row">
                                            <div class="key-pair-col form-group">
                                                <label for="lookup-key-opp-1">Matching key type</label>
                                                <select id="lookup-key-opp-1"><option selected>Opportunity</option><option>Account</option></select>
                                            </div>
                                            <div class="key-pair-col form-group">
                                                <label for="source-key-opp-1">Matching key</label>
                                                <select id="source-key-opp-1"><option selected>opportunity_id</option></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Key Pair 2: TPR/Profile Join -->
                                <div class="join-pair-card">
                                    <div class="join-pair-header">
                                        <h4>Key pair #2</h4>
                                        <div class="path-name-group">
                                            <label for="path-name-opp-2">Path name:</label>
                                            <input type="text" id="path-name-opp-2" value="Account_Opportunities_Join">
                                        </div>
                                    </div>
                                    <div class="join-pair-body">
                                        <div class="radio-group">
                                            <label><input type="radio" name="match-method-opp-2" onclick="toggleOppJoinType(2, 'field')"> <span class="radio-label">Match by field</span></label>
                                            <label><input type="radio" name="match-method-opp-2" checked onclick="toggleOppJoinType(2, 'container')"> <span class="radio-label">Match by <strong>container</strong></span></label>
                                        </div>
                                        <div class="key-pair-row">
                                            <div class="key-pair-col form-group">
                                                <label for="lookup-key-opp-2">Matching key type</label>
                                                <select id="lookup-key-opp-2"><option>Opportunity</option><option selected>Account</option></select>
                                            </div>
                                            <div class="key-pair-col form-group">
                                                <label for="source-key-opp-2">Account field</label>
                                                <select id="source-key-opp-2"><option selected>account_id</option></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button class="button button-secondary" onclick="alert('This would add a new, empty key pair card.')" style="margin-top: 20px;">+ Add new pair</button>
                            </div>
                        </div>

                        <!-- Buying Group Lookup Card -->
                        <div class="dataset-card">
                            <div class="dataset-card-header">Buying Group Lookup</div>
                            <div class="dataset-card-body">
                                <!-- Key Pair 1: Event Join -->
                                <div class="join-pair-card">
                                    <div class="join-pair-header">
                                        <h4>Key pair #1</h4>
                                        <div class="path-name-group">
                                            <label for="path-name-bg-1">Path name:</label>
                                            <input type="text" id="path-name-bg-1" value="Event_BuyingGroup_Join">
                                        </div>
                                    </div>
                                    <div class="join-pair-body">
                                        <div class="radio-group">
                                            <label><input type="radio" name="match-method-bg-1" onclick="toggleBgJoinType(1, 'field')"> <span class="radio-label">Match by field</span></label>
                                            <label><input type="radio" name="match-method-bg-1" checked onclick="toggleBgJoinType(1, 'container')"> <span class="radio-label">Match by <strong>container</strong></span></label>
                                        </div>
                                        <div class="key-pair-row">
                                            <div class="key-pair-col form-group">
                                                <label for="lookup-key-bg-1">Matching key type</label>
                                                <select id="lookup-key-bg-1"><option selected>Buying Group</option><option>Account</option></select>
                                            </div>
                                            <div class="key-pair-col form-group">
                                                <label for="source-key-bg-1">Matching key</label>
                                                <select id="source-key-bg-1"><option selected>buying_group_id</option></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Key Pair 2: TPR/Profile Join -->
                                <div class="join-pair-card">
                                    <div class="join-pair-header">
                                        <h4>Key pair #2</h4>
                                        <div class="path-name-group">
                                            <label for="path-name-bg-2">Path name:</label>
                                            <input type="text" id="path-name-bg-2" value="Account_BuyingGroups_Join">
                                        </div>
                                    </div>
                                    <div class="join-pair-body">
                                        <div class="radio-group">
                                            <label><input type="radio" name="match-method-bg-2" onclick="toggleBgJoinType(2, 'field')"> <span class="radio-label">Match by field</span></label>
                                            <label><input type="radio" name="match-method-bg-2" checked onclick="toggleBgJoinType(2, 'container')"> <span class="radio-label">Match by <strong>container</strong></span></label>
                                        </div>
                                        <div class="key-pair-row">
                                            <div class="key-pair-col form-group">
                                                <label for="lookup-key-bg-2">Matching key type</label>
                                                <select id="lookup-key-bg-2"><option>Buying Group</option><option selected>Account</option></select>
                                            </div>
                                            <div class="key-pair-col form-group">
                                                <label for="source-key-bg-2">Account field</label>
                                                <select id="source-key-bg-2"><option selected>account_id</option></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button class="button button-secondary" onclick="alert('This would add a new, empty key pair card.')" style="margin-top: 20px;">+ Add new pair</button>
                            </div>
                        </div>
                        <button class="button button-primary" onclick="alert('Connection saved (demo)')" style="margin-top: 20px;">Save connection</button>
                    </div>
                    <!-- Event Datasets Pane (Placeholder) -->
                    <div id="conn-tab-event" class="connection-pane d-none">
                        <h3>Event datasets</h3>
                        <p>This is where you would map your event dataset's ID fields (e.g., `event.opportunityId`) to the `Opportunity` container, `event.accountId` to the `Account` container, etc. This enables the event-based joins.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== TAB 4: DATA VIEW CONFIG ===== -->
    <div id="tab-4" class="main-tab-content main-tab-pane">
        <div class="dv-container">
            <!-- Header -->
            <div class="dv-header">
                <div class="dv-header-title">Data views > <span>B2B Strategic DV</span></div>
                <div class="dv-header-buttons">
                    <button class="button button-secondary">Close</button>
                    <button class="button button-secondary">Save</button>
                    <button class="button button-primary">Save and continue</button>
                </div>
            </div>
            <!-- Subnav -->
            <div class="dv-subnav">
                <div class="dv-subnav-item">Configure</div>
                <div class="dv-subnav-item active">Components</div>
                <div class="dv-subnav-item">Settings</div>
            </div>
            <!-- Body -->
            <div class="dv-body">
                <!-- Left Panel -->
                <div class="dv-left-panel">
                    <div class="dv-search-bar">
                        <svg><use href="#icon-search"></use></svg>
                        <input type="text" placeholder="Search components" onkeyup="filterComponents(this.value)">
                    </div>

                    <div class="dv-dataset-group expanded" data-group-id="group-system">
                        <h4 onclick="toggleDvGroup('group-system')">SYSTEM-GENERATED COMPONENTS</h4>
                        <div class="dv-component-list" style="display: block; background: transparent; border: none; padding: 0;">
                            <div id="dv-comp-total-accounts" class="dv-component-item" data-name="Total Accounts">
                                <svg class="icon icon-system"><use href="#icon-system"></use></svg>
                                <div class="component-text">
                                    <div class="component-name">Total Accounts</div>
                                    <div class="component-path">System-Generated</div>
                                </div>
                                <button class="dv-add-btn" onclick="dvAddComponent('total-accounts', 'system')">+</button>
                            </div>
                            <div id="dv-comp-total-opps" class="dv-component-item" data-name="Total Opportunities">
                                <svg class="icon icon-system"><use href="#icon-system"></use></svg>
                                <div class="component-text">
                                    <div class="component-name">Total Opportunities</div>
                                    <div class="component-path">System-Generated</div>
                                </div>
                                <button class="dv-add-btn" onclick="dvAddComponent('total-opps', 'system')">+</button>
                            </div>
                            <div id="dv-comp-total-bgs" class="dv-component-item" data-name="Total Buying Groups">
                                <svg class="icon icon-system"><use href="#icon-system"></use></svg>
                                <div class="component-text">
                                    <div class="component-name">Total Buying Groups</div>
                                    <div class="component-path">System-Generated</div>
                                </div>
                                <button class="dv-add-btn" onclick="dvAddComponent('total-bgs', 'system')">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dv-dataset-group expanded" data-group-id="group-account">
                        <h4 onclick="toggleDvGroup('group-account')">ACCOUNT LOOKUP (PROFILE)</h4>
                        <div class="dv-component-list" style="display: block; background: transparent; border: none; padding: 0;">
                            <div id="dv-comp-tier" class="dv-component-item" data-name="Account Tier">
                                <svg class="icon icon-dim"><use href="#icon-dim"></use></svg>
                                <div class="component-text">
                                    <div class="component-name">Account Tier</div>
                                </div>
                                <button class="dv-add-btn" onclick="dvAddComponent('tier', 'account')">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="dv-dataset-group expanded" data-group-id="group-opp" data-path-aware="true">
                        <h4 onclick="toggleDvGroup('group-opp')">OPPORTUNITY LOOKUP (LOOKUP)</h4>
                        <div class="dv-path-selector">
                            <label>Choose a join path</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="path-opp" value="Event_Opportunity_Join" onchange="selectDvPath('group-opp', this.value)"> 
                                    <span class="radio-label">Event_Opportunity_Join</span>
                                </label>
                                <label>
                                    <input type="radio" name="path-opp" value="Account_Opportunities_Join" onchange="selectDvPath('group-opp', this.value)">
                                    <span class="radio-label">Account_Opportunities_Join</span>
                                </label>
                            </div>
                        </div>
                        <div class="dv-component-list">
                            <div id="dv-comp-opp-value" class="dv-component-item" data-name="Opportunity Value">
                                <svg class="icon icon-metric"><use href="#icon-metric"></use></svg>
                                <div class="component-text">
                                    <div class="component-name">Opportunity Value</div>
                                </div>
                                <button class="dv-add-btn" onclick="dvAddComponent('opp-value', 'group-opp')">+</button>
                            </div>
                            <div id="dv-comp-opp-status" class="dv-component-item" data-name="Opportunity Status">
                                <svg class="icon icon-dim"><use href="#icon-dim"></use></svg>
                                <div class="component-text">
                                    <div class="component-name">Opportunity Status</div>
                                </div>
                                <button class="dv-add-btn" onclick="dvAddComponent('opp-status', 'group-opp')">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="dv-dataset-group expanded" data-group-id="group-bg" data-path-aware="true">
                        <h4 onclick="toggleDvGroup('group-bg')">BUYING GROUP LOOKUP (LOOKUP)</h4>
                        <div class="dv-path-selector">
                             <label>Choose a join path</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="path-bg" value="Event_BuyingGroup_Join" onchange="selectDvPath('group-bg', this.value)"> 
                                    <span class="radio-label">Event_BuyingGroup_Join</span>
                                </label>
                                <label>
                                    <input type="radio" name="path-bg" value="Account_BuyingGroups_Join" onchange="selectDvPath('group-bg', this.value)">
                                    <span class="radio-label">Account_BuyingGroups_Join</span>
                                </label>
                            </div>
                        </div>
                        <div class="dv-component-list">
                            <div id="dv-comp-group-name" class="dv-component-item" data-name="Group Name">
                                <svg class="icon icon-dim"><use href="#icon-dim"></use></svg>
                                <div class="component-text">
                                    <div class="component-name">Group Name</div>
                                </div>
                                <button class="dv-add-btn" onclick="dvAddComponent('group-name', 'group-bg')">+</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Middle Panel -->
                <div class="dv-middle-panel">
                    <table id="dv-included-table">
                        <thead>
                            <tr>
                                <th>COMPONENT NAME</th>
                                <th>DATASET</th>
                                <th>SCHEMA PATH</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Components will be added here by JS -->
                        </tbody>
                    </table>
                </div>
                <!-- Right Panel -->
                <div class="dv-right-panel">
                    <div id="dv-settings-placeholder">
                        <div class="dv-right-panel-placeholder">
                            <svg><use href="#icon-settings"></use></svg>
                            <h4>Select a component</h4>
                            <p>Select a component or metric from the list to view the available settings.</p>
                        </div>
                    </div>
                    <div id="dv-settings-panel" class="d-none">
                        <!-- Settings will be injected here by JS -->
                    </div>
                </div>
            </div>
        </div>
        <div class="info-box" style="margin-top: 25px;">
            <strong>Your Goal:</strong>
            <ol>
                <li>In the left panel, add <strong>Total Opportunities</strong>, <strong>Total Buying Groups</strong>, and <strong>Account Tier</strong>.</li>
                <li>Under "OPPORTUNITY LOOKUP", select the <strong><code>Account_Opportunities_Join</code></strong> path. Add <strong>Opportunity Value</strong> and <strong>Opportunity Status</strong>.</li>
                <li>In the middle table, click the "Opportunity Value" component. The settings panel appears on the right.</li>
                <li>Rename it to <strong>"Total Opportunity Value"</strong>, set its <strong>Scope</strong> to <strong>Total Population (Profile-based)</strong>, and <strong>Behavior</strong> to <strong>Sum</strong>.</li>
            </ol>
        </div>
    </div>

    <!-- ===== TAB 5: WORKSPACE ANALYSIS ===== -->
    <div id="tab-5" class="main-tab-content main-tab-pane">
        <h2>Workspace Analysis</h2>
        <p>The sales leadership team can now build their report in Analysis Workspace.</p>
        
        <div class="workspace-ui">
            <div class="panel">
                <div class="panel-header">
                    <span class="date-range">
                        Date Range: This Year (<strong>Irrelevant for this Profile-Only Query</strong>)
                    </span>
                </div>
                <div class="panel-body">
                    <p>They drag over <code>Account Tier</code>, the TPR metrics <code>Total Opportunities</code>, <code>Total Buying Groups</code>, and their new custom metric <code>Total Opportunity Value</code> (which is scoped to the `Account_Opportunities_Join` path).</p>
                    <p>Finally, they apply a filter/segment for <code>Opportunity Status = Open</code> (which also uses the `Account_Opportunities_Join` path) to the <code>Total Opportunities</code> and <code>Total Opportunity Value</code> columns.</p>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Account Tier</th>
                                <th>Total Open Opportunities</th>
                                <th>Total Open Opp Value (TPR)</th>
                                <th>Total Buying Groups</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Enterprise</td><td>2</td><td>$1,500,000</td><td>3</td></tr>
                            <tr><td>Pro</td><td>1</td><td>$100,000</td><td>1</td></tr>
                            <tr><td>SMB</td><td>1</td><td>$50,000</td><td>0</td></tr>
                            <tr>
                                <td><strong>Total</strong></td>
                                <td><strong>4</strong></td>
                                <td><strong>$1,650,000</strong></td>
                                <td><strong>4</strong></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="explanation">
                        <h3>How This Query Works (The Logic)</h3>
                        <p>This report is generated by querying the profile and lookup datasets directly.</p>
                        <ol>
                            <li>
                                <strong>Dimension (<code>Account Tier</code>):</strong> The system queries the <em>entire</em> <code>Account Lookup</code> (4 accounts) and groups them by the <code>account_tier</code> attribute.
                            </li>
                            <li>
                                <strong>Metric 1 (<code>Total Open Opportunities</code>):</strong> This is the <code>Total Opportunities</code> (TPR) system metric, filtered by <code>Opportunity Status = Open</code>.
                                <ul>
                                    <li>The query uses the <strong><code>Account_Opportunities_Join</code></strong> path to find all opportunities for the accounts in each tier and counts those with <code>status = Open</code>.
                                    <li><strong>Enterprise:</strong> A-100 (O-1001) and A-400 (O-4001) = <strong>2</strong>
                                    <li><strong>Pro:</strong> A-200 (O-2001) = <strong>1</strong>
                                    <li><strong>SMB:</strong> A-300 (O-3001) = <strong>1</strong>
                                </ul>
                            </li>
                             <li>
                                <strong>Metric 2 (<code>Total Open Opp Value (TPR)</code>):</strong> This is our custom TPR metric, also filtered by <code>Opportunity Status = Open</code>.
                                 <ul>
                                    <li>It uses the <strong><code>Account_Opportunities_Join</code></strong> path to find the <code>opportunity_value</code> for the open opps and sums them.
                                    <li><strong>Enterprise:</strong> $500,000 (O-1001) + $1,000,000 (O-4001) = <strong>$1,500,000</strong>
                                    <li><strong>Pro:</strong> $100,000 (O-2001) = <strong>$100,000</strong>
                                    <li><strong>SMB:</strong> $50,000 (O-3001) = <strong>$50,000</strong>
                                </ul>
                            </li>
                            <li>
                                <strong>Metric 3 (<code>Total Buying Groups</code>):</strong> This is the <code>Total Buying Groups</code> (TPR) system metric.
                                <ul>
                                    <li>The query uses the <strong><code>Account_BuyingGroups_Join</code></strong> path to find all buying groups for the accounts in each tier.
                                    <li><strong>Enterprise:</strong> A-100 (BG-111, BG-112) and A-400 (BG-444) = <strong>3</strong>
                                    <li><strong>Pro:</strong> A-200 (BG-222) = <strong>1</strong>
                                    <li><strong>SMB:</strong> A-300 (none) = <strong>0</strong>
                                </ul>
                            </li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
        <div class="info-box" style="margin-top: 25px;">
            <strong>Unlocked Business Value:</strong> The sales leaders now have a complete, time-insensitive view of their entire account portfolio's value. They can clearly see that their "Enterprise" accounts represent $1.5M in open pipeline and are also the most complex (3 buying groups). This justifies assigning more resources to those key accounts.
        </div>
    </div>
</div>

<script>
    // --- Main Tab Navigation ---
    function openMainTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("main-tab-pane");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("main-tab-link");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    // --- Tab 3: Connection Setup ---
    function switchConnectionTab(evt, tabId) {
        document.querySelectorAll('.connection-pane').forEach(p => p.classList.add('d-none'));
        document.querySelectorAll('.connection-nav-item').forEach(i => i.classList.remove('active'));
        
        const pane = document.getElementById(tabId);
        if (pane) {
            pane.classList.remove('d-none');
        } else {
            console.error("Connection pane not found:", tabId);
        }
        
        if (evt && evt.currentTarget) {
            evt.currentTarget.classList.add('active');
        }
    }

    // --- Tab 4: Data View Config ---
    const dvState = {
        sourceComponents: {
            'total-accounts': { id: 'total-accounts', name: 'Total Accounts', dataset: 'System', path: 'n/a', type: 'system', settings: { scope: 'Total Population (Profile-based)', behavior: 'Count Instances' } },
            'total-opps': { id: 'total-opps', name: 'Total Opportunities', dataset: 'System', path: 'n/a', type: 'system', settings: { scope: 'Total Population (Profile-based)', behavior: 'Count Instances' } },
            'total-bgs': { id: 'total-bgs', name: 'Total Buying Groups', dataset: 'System', path: 'n/a', type: 'system', settings: { scope: 'Total Population (Profile-based)', behavior: 'Count Instances' } },
            'tier': { id: 'tier', name: 'Account Tier', dataset: 'Account Lookup', path: 'Account Lookup', type: 'dim', settings: {} },
            'opp-value': { id: 'opp-value', name: 'Opportunity Value', dataset: 'Opportunity Lookup', path: '', type: 'metric', settings: { scope: 'Event-based (Occurrences)', behavior: 'Sum' } }, // Path set on add
            'opp-status': { id: 'opp-status', name: 'Opportunity Status', dataset: 'Opportunity Lookup', path: '', type: 'dim', settings: {} }, // Path set on add
            'group-name': { id: 'group-name', name: 'Group Name', dataset: 'Buying Group Lookup', path: '', type: 'dim', settings: {} } // Path set on add
        },
        includedComponents: [],
        selectedInstanceId: null,
        componentCounter: 0,
        selectedPaths: {
            'group-opp': null,
            'group-bg': null
        }
    };

    function filterComponents(value) {
        const searchTerm = value.toLowerCase();
        document.querySelectorAll('.dv-component-item').forEach(item => {
            const name = item.getAttribute('data-name').toLowerCase();
            if (name.includes(searchTerm)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function toggleDvGroup(groupId) {
        document.querySelector(`.dv-dataset-group[data-group-id='${groupId}']`).classList.toggle('expanded');
    }

    function selectDvPath(groupId, pathValue) {
        dvState.selectedPaths[groupId] = pathValue;
        const groupEl = document.querySelector(`.dv-dataset-group[data-group-id='${groupId}']`);
        groupEl.classList.add('dv-path-selected');
    }

    function dvAddComponent(id, groupId) {
        const sourceComp = dvState.sourceComponents[id];
        if (!sourceComp) return;

        let path = sourceComp.path; // Get default path
        const groupEl = document.querySelector(`.dv-dataset-group[data-group-id='${groupId}']`);

        // Check if this component belongs to a path-aware group
        if (groupEl && groupEl.getAttribute('data-path-aware') === 'true') {
            const selectedPath = dvState.selectedPaths[groupId];
            if (!selectedPath) {
                alert('Please select a join path first.');
                return;
            }
            path = `${sourceComp.dataset} → ${selectedPath}`;
        }
        
        dvState.componentCounter++;
        const instanceId = `${id}-${dvState.componentCounter}`;
        
        const newInstance = JSON.parse(JSON.stringify(sourceComp)); // deep copy
        newInstance.instanceId = instanceId;
        newInstance.path = path; // Set the selected path

        dvState.includedComponents.push(newInstance);
        renderDataView();
        dvSelectComponent(instanceId);
    }

    function dvSelectComponent(id) {
        dvState.selectedInstanceId = id;
        renderDataView();
    }

    function dvSaveSettings() {
        const id = dvState.selectedInstanceId;
        if (!id) return;
        
        const comp = dvState.includedComponents.find(c => c.instanceId === id);
        if (!comp) return;

        comp.name = document.getElementById('setting-name').value;
        
        if(comp.type === 'metric' || comp.type === 'system') {
            comp.settings.scope = document.getElementById('setting-scope').value;
            comp.settings.behavior = document.getElementById('setting-behavior').value;
        }
        
        dvState.selectedInstanceId = null; // Deselect after saving
        renderDataView();
        alert('Settings saved!');
    }

    function renderDataView() {
        // Render Middle Panel (Included)
        const tableBody = document.querySelector('#dv-included-table tbody');
        tableBody.innerHTML = '';
        dvState.includedComponents.forEach(comp => {
            const row = document.createElement('tr');
            row.onclick = () => dvSelectComponent(comp.instanceId);
            if (comp.instanceId === dvState.selectedInstanceId) {
                row.classList.add('selected');
            }
            
            let iconSvg = '';
            if(comp.type === 'metric') iconSvg = `<svg class="icon icon-metric"><use href="#icon-metric"></use></svg>`;
            else if(comp.type === 'dim') iconSvg = `<svg class="icon icon-dim"><use href="#icon-dim"></use></svg>`;
            else if(comp.type === 'system') iconSvg = `<svg class="icon icon-system"><use href="#icon-system"></use></svg>`;

            row.innerHTML = `
                <td>${iconSvg} <span class="component-name">${comp.name}</span></td>
                <td>${comp.dataset}</td>
                <td>${comp.path}</td>
            `;
            tableBody.appendChild(row);
        });

        // Render Right Panel (Settings)
        const placeholder = document.getElementById('dv-settings-placeholder');
        const settingsPanel = document.getElementById('dv-settings-panel');
        if (!dvState.selectedInstanceId) {
            placeholder.classList.remove('d-none');
            settingsPanel.classList.add('d-none');
            settingsPanel.innerHTML = '';
        } else {
            placeholder.classList.add('d-none');
            settingsPanel.classList.remove('d-none');
            
            const comp = dvState.includedComponents.find(c => c.instanceId === dvState.selectedInstanceId);
            if (!comp) return;

            let settingsHtml = `
                <div class="dv-right-panel-settings">
                    <h3>Component settings</h3>
                    <div class="form-group">
                        <label for="setting-name">NAME</label>
                        <input type="text" id="setting-name" value="${comp.name}">
                    </div>
            `;
            
            if(comp.type === 'metric' || comp.type === 'system') {
                const isSystem = comp.type === 'system';
                settingsHtml += `
                    <div class="form-group">
                        <label for="setting-scope">SCOPE</label>
                        <select id="setting-scope" ${isSystem ? 'disabled' : ''}>
                            <option value="Event-based (Occurrences)" ${comp.settings.scope === 'Event-based (Occurrences)' ? 'selected' : ''}>Event-based (Occurrences)</option>
                            <option value="Total Population (Profile-based)" ${comp.settings.scope === 'Total Population (Profile-based)' ? 'selected' : ''}>Total Population (Profile-based)</option>
                        </select>
                        ${comp.type === 'metric' ? '<small style="color: #555; font-size: 13px;">Select "Total Population" to query all profiles, ignoring events.</small>' : ''}
                        ${isSystem ? '<div class="info-box" style="padding: 10px; font-size: 13px; margin-top: 10px;"><strong>System Metric:</strong> Scope is locked for system-generated TPR metrics.</div>' : ''}
                    </div>
                    <div class="form-group">
                        <label for="setting-behavior">BEHAVIOR</label>
                        <select id="setting-behavior" ${isSystem ? 'disabled' : ''}>
                            <option value="Sum" ${comp.settings.behavior === 'Sum' ? 'selected' : ''}>Sum</option>
                            <option value="Count Instances" ${comp.settings.behavior === 'Count Instances' ? 'selected' : ''}>Count Instances</option>
                            <option value="Average" ${comp.settings.behavior === 'Average' ? 'selected' : ''}>Average</option>
                            <option value="Min" ${comp.settings.behavior === 'Min' ? 'selected' : ''}>Min</option>
                            <option value="Max" ${comp.settings.behavior === 'Max' ? 'selected' : ''}>Max</option>
                        </select>
                    </div>
                `;
            }

            settingsHtml += `
                    <button class="button button-primary" onclick="dvSaveSettings()">Save</button>
                </div>
            `;
            settingsPanel.innerHTML = settingsHtml;
        }
    }

    // Initial render
    document.addEventListener("DOMContentLoaded", function() {
        openMainTab({currentTarget: document.querySelector('.main-tab-link.active')}, 'tab-1');
        renderDataView();
    });
</script>

</body>
</html>

