<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    /* Adobe-inspired palette and global styles */
    :root {
        --adobe-blue: #0265dc;
        --adobe-blue-hover: #0052b3;
        --adobe-gray-50: #fafafa;
        --adobe-gray-100: #f4f4f4;
        --adobe-gray-200: #eaeaea;
        --adobe-gray-300: #e3e3e3;
        --adobe-gray-400: #d3d3d3;
        --adobe-gray-500: #cacaca;
        --adobe-gray-600: #b2b2b2;
        --adobe-gray-700: #8e8e8e;
        --adobe-gray-800: #505050;
        --adobe-gray-900: #323232;
        --text-color: #4b4b4b;
        --metric-color: #e67e22;
        --dim-color: #0c84e8;
        --system-color: #6c757d;
        --radio-checked-color: var(--adobe-blue);
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background-color: var(--adobe-gray-100);
        color: var(--text-color);
        margin: 0;
        padding: 0;
    }
    .preview-container {
        max-width: 1400px;
        margin: 20px auto;
        background: #fff;
        border: 1px solid var(--adobe-gray-300);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    
    /* Main Tab Navigation */
    .main-tab-bar {
        display: flex;
        background-color: var(--adobe-gray-50);
        border-bottom: 1px solid var(--adobe-gray-300);
        padding: 0 20px;
    }
    .main-tab-link {
        padding: 16px 20px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        font-weight: 600;
        color: var(--adobe-gray-700);
        font-size: 16px;
        transition: all 0.2s ease;
        margin-right: 10px;
    }
    .main-tab-link:hover {
        background-color: var(--adobe-gray-100);
        color: var(--adobe-blue);
    }
    .main-tab-link.active {
        border-bottom-color: var(--adobe-blue);
        color: var(--adobe-blue);
        background-color: #fff;
    }
    .main-tab-content {
        padding: 25px;
        min-height: 650px;
    }
    .main-tab-pane {
        display: none;
    }
    .main-tab-pane.active {
        display: block;
    }

    /* General Content Styling */
    h2 {
        color: #000;
        border-bottom: 1px solid var(--adobe-gray-200);
        padding-bottom: 10px;
        margin-top: 0;
        font-size: 24px;
        font-weight: 400;
    }
    h3 {
        color: var(--adobe-gray-900);
        margin-top: 25px;
        margin-bottom: 10px;
        font-size: 18px;
        font-weight: 600;
    }
    p, li {
        font-size: 16px;
        line-height: 1.6;
    }
    code {
        background-color: #eef;
        padding: 3px 6px;
        border-radius: 4px;
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    }
    .info-box {
        background-color: #f4f8ff;
        border: 1px solid #c9ddff;
        border-left: 4px solid var(--adobe-blue);
        padding: 15px 20px;
        margin: 20px 0;
        border-radius: 5px;
    }
    .info-box strong {
        color: #0056b3;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border: 1px solid var(--adobe-gray-300);
        border-radius: 6px;
        overflow: hidden;
    }
    th, td {
        border-bottom: 1px solid var(--adobe-gray-300);
        padding: 12px 15px;
        text-align: left;
    }
    th {
        background-color: var(--adobe-gray-50);
        font-weight: 600;
        font-size: 14px;
    }
    tbody tr:last-child th,
    tbody tr:last-child td {
        border-bottom: none;
    }
    tr:nth-child(even) {
        background-color: var(--adobe-gray-50);
    }

    /* Spectrum-like Button */
    .button {
        padding: 8px 16px;
        font-size: 15px;
        font-weight: 600;
        border-radius: 16px; /* Pill shape */
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
        line-height: 1.5;
    }
    .button-primary {
        background-color: var(--adobe-blue);
        color: #fff;
        border-color: var(--adobe-blue);
    }
    .button-primary:hover { 
        background-color: var(--adobe-blue-hover); 
        border-color: var(--adobe-blue-hover);
    }
    .button-secondary {
        background-color: #fff;
        color: var(--adobe-gray-800);
        border-color: var(--adobe-gray-400);
    }
    .button-secondary:hover { 
        background-color: var(--adobe-gray-100);
        border-color: var(--adobe-gray-600);
    }

    /* --- Tab 3: Connection Setup --- */
    .connection-container {
        border: 1px solid var(--adobe-gray-400);
        border-radius: 6px;
        background: #fff;
        min-height: 600px;
    }
    .connection-header {
        padding: 12px 20px;
        background: var(--adobe-gray-50);
        border-bottom: 1px solid var(--adobe-gray-300);
    }
    .connection-header h2 {
        font-size: 20px;
        font-weight: 600;
        margin: 0;
        padding: 0;
        border: none;
        color: var(--adobe-gray-900);
    }
    .connection-body {
        display: flex;
    }
    .connection-left-nav {
        width: 250px;
        border-right: 1px solid var(--adobe-gray-300);
        padding: 20px 0;
        background: var(--adobe-gray-50);
    }
    .connection-nav-item {
        padding: 12px 20px;
        font-weight: 500;
        color: var(--adobe-gray-800);
        cursor: pointer;
        border-left: 3px solid transparent;
    }
    .connection-nav-item:hover {
        background: var(--adobe-gray-100);
        color: var(--adobe-blue);
    }
    .connection-nav-item.active {
        background: #fff;
        color: var(--adobe-blue);
        border-left-color: var(--adobe-blue);
        font-weight: 600;
    }
    .connection-main {
        flex: 1;
        padding: 25px;
    }
    .connection-main h3 {
        font-size: 20px;
        font-weight: 600;
        margin-top: 0;
    }
    .dataset-card {
        border: 1px solid var(--adobe-gray-400);
        border-radius: 6px;
        margin-bottom: 20px;
    }
    .dataset-card-header {
        padding: 15px 20px;
        background: var(--adobe-gray-50);
        border-bottom: 1px solid var(--adobe-gray-300);
        font-weight: 600;
    }
    .dataset-card-body {
        padding: 20px;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 8px;
    }
    .form-group select, .form-group input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--adobe-gray-400);
        border-radius: 4px;
        box-sizing: border-box; 
        font-size: 15px;
    }
    
    /* New Connection Join UI */
    .join-pair-card {
        border: 1px solid var(--adobe-gray-300);
        border-radius: 6px;
        margin-top: 20px;
    }
    .join-pair-header {
        padding: 10px 20px;
        background: var(--adobe-gray-100);
        border-bottom: 1px solid var(--adobe-gray-300);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .join-pair-header h4 {
        margin: 0;
        font-size: 16px;
    }
    .path-name-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .path-name-group label {
        font-size: 14px;
        font-weight: 600;
    }
    .path-name-group input {
        padding: 6px 10px;
        border-radius: 4px;
        border: 1px solid var(--adobe-gray-400);
        font-size: 14px;
        font-weight: 600;
        color: var(--adobe-blue);
    }
    .join-pair-body {
        padding: 25px;
    }
    .radio-group {
        margin-bottom: 20px;
    }
    .radio-group label {
        display: inline-block;
        margin-right: 20px;
        font-weight: 500;
        cursor: pointer;
    }
    .radio-group input[type="radio"] {
        display: none;
    }
    .radio-group input[type="radio"] + .radio-label::before {
        content: '';
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 2px solid var(--adobe-gray-500);
        border-radius: 50%;
        margin-right: 8px;
        vertical-align: middle;
        transition: all 0.2s;
    }
    .radio-group input[type="radio"]:checked + .radio-label::before {
        border-color: var(--radio-checked-color);
        background-color: #fff;
        box-shadow: 0 0 0 4px #fff inset, 0 0 0 10px var(--radio-checked-color) inset;
    }
    .key-pair-row {
        display: flex;
        align-items: center;
        gap: 20px;
    }
    .key-pair-col {
        flex: 1;
    }
    
    /* --- Tab 4: Data View Config --- */
    .dv-container {
        border: 1px solid var(--adobe-gray-300);
        background: #fff;
        height: 700px;
        display: flex;
        flex-direction: column;
    }
    .dv-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 20px;
        border-bottom: 1px solid var(--adobe-gray-300);
        background: var(--adobe-gray-50);
    }
    .dv-header-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--adobe-gray-800);
    }
    .dv-header-title span {
        color: var(--adobe-gray-900);
        font-weight: 700;
    }
    .dv-header-buttons .button {
        margin-left: 10px;
    }
    .dv-subnav {
        display: flex;
        padding: 0 20px;
        border-bottom: 1px solid var(--adobe-gray-300);
    }
    .dv-subnav-item {
        padding: 12px 16px;
        font-weight: 600;
        color: var(--adobe-gray-700);
        border-bottom: 3px solid transparent;
        cursor: pointer;
    }
    .dv-subnav-item.active {
        color: var(--adobe-blue);
        border-bottom-color: var(--adobe-blue);
    }
    .dv-body {
        display: flex;
        flex: 1;
        overflow: hidden;
    }
    .dv-left-panel {
        width: 25%;
        border-right: 1px solid var(--adobe-gray-300);
        padding: 20px;
        overflow-y: auto;
        background: var(--adobe-gray-50);
    }
    .dv-middle-panel {
        width: 45%;
        border-right: 1px solid var(--adobe-gray-300);
        overflow-y: auto;
    }
    .dv-right-panel {
        width: 30%;
        overflow-y: auto;
        background: var(--adobe-gray-50);
    }
    .dv-search-bar {
        position: relative;
        margin-bottom: 20px;
    }
    .dv-search-bar input {
        width: 100%;
        padding: 10px 10px 10px 35px;
        border-radius: 4px;
        border: 1px solid var(--adobe-gray-400);
        box-sizing: border-box;
    }
    .dv-search-bar svg {
        position: absolute;
        left: 10px;
        top: 11px;
        width: 16px;
        height: 16px;
        color: var(--adobe-gray-700);
    }
    .dv-dataset-group h4 {
        margin: 20px 0 10px;
        font-size: 14px;
        font-weight: 600;
        color: var(--adobe-gray-800);
        cursor: pointer;
        display: flex;
        align-items: center;
    }
    .dv-dataset-group h4::before {
        content: '►';
        font-size: 10px;
        margin-right: 8px;
        transition: transform 0.2s;
    }
    .dv-dataset-group.expanded h4::before {
        transform: rotate(90deg);
    }
    .dv-component-list {
        padding-left: 10px;
        display: none;
    }
    .dv-dataset-group.expanded .dv-component-list {
        display: block;
    }
    .dv-component-item {
        display: flex;
        align-items: center;
        padding: 8px;
        margin-bottom: 5px;
        border-radius: 4px;
    }
    .dv-component-item .icon {
        width: 24px;
        height: 24px;
        margin-right: 8px;
    }
    .dv-component-item .component-text {
        flex: 1;
    }
    .dv-component-item .component-name {
        font-weight: 500;
        font-size: 15px;
    }
    .dv-component-item .component-path {
        font-size: 12px;
        color: var(--adobe-gray-700);
    }
    .dv-add-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 1px solid var(--adobe-gray-400);
        background: #fff;
        color: var(--adobe-gray-700);
        font-size: 20px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 28px;
        transition: all 0.2s;
    }
    .dv-add-btn:hover {
        border-color: var(--adobe-blue);
        color: var(--adobe-blue);
    }
    .dv-component-item.added {
        /* opacity: 0.5; */ /* <-- REMOVED this line */
        /* background: var(--adobe-gray-100); */ /* <-- REMOVED this line */
    }
    .dv-component-item.added .dv-add-btn {
        /* display: none; */ /* <-- REMOVED this line */
    }

    .dv-middle-panel table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
        border: none;
        box-shadow: none;
        border-radius: 0;
    }
    .dv-middle-panel th {
        font-size: 12px;
        font-weight: 600;
        color: var(--adobe-gray-700);
        text-transform: uppercase;
        padding: 10px 15px;
    }
    .dv-middle-panel td {
        padding: 12px 15px;
        font-size: 15px;
    }
    .dv-middle-panel tbody tr {
        cursor: pointer;
    }
    .dv-middle-panel tbody tr:hover {
        background: #f4f8ff;
    }
    .dv-middle-panel tbody tr.selected {
        background: #e6f2ff;
        border-left: 3px solid var(--adobe-blue);
    }
    .dv-middle-panel .icon {
        width: 20px;
        height: 20px;
        margin-right: 8px;
        vertical-align: middle;
    }
    .dv-middle-panel .component-name {
        font-weight: 500;
    }
    .dv-right-panel-placeholder {
        padding: 40px;
        text-align: center;
        color: var(--adobe-gray-700);
    }
    .dv-right-panel-placeholder svg {
        width: 60px;
        height: 60px;
        color: var(--adobe-gray-400);
        margin-bottom: 20px;
    }
    .dv-right-panel-settings {
        padding: 25px;
    }
    .dv-right-panel-settings h3 {
        font-size: 18px;
        font-weight: 600;
        margin-top: 0;
    }
    .dv-right-panel-settings .form-group label {
        font-size: 12px;
        text-transform: uppercase;
        color: var(--adobe-gray-700);
    }

    /* --- Tab 5: Workspace Analysis --- */
    .workspace-ui {
        background: var(--adobe-gray-100);
        border: 1px solid var(--adobe-gray-300);
        border-radius: 6px;
        padding: 20px;
    }
    .panel {
        background: #fff;
        border-radius: 6px;
        box-shadow: 0 3px 8px rgba(0,0,0,0.08);
        border: 1px solid var(--adobe-gray-300);
    }
    .panel-header {
        padding: 12px 20px;
        border-bottom: 1px solid var(--adobe-gray-200);
    }
    .panel-header .date-range {
        font-size: 14px;
        color: var(--adobe-gray-800);
        background: var(--adobe-gray-100);
        padding: 5px 10px;
        border-radius: 4px;
    }
    .panel-header .date-range strong {
        color: #c00;
        font-weight: 600;
    }
    .panel-body {
        padding: 20px;
    }
    .panel-body table {
        border: none;
        box-shadow: none;
    }
    .panel-body table th {
        background-color: var(--adobe-gray-100);
    }
    .panel-body table th, .panel-body table td {
        text-align: right;
        padding: 14px;
    }
    .panel-body table th:first-child,
    .panel-body table td:first-child {
        text-align: left;
        font-weight: 600;
    }
    .panel-body table tr:last-child {
        background-color: var(--adobe-gray-100);
        font-weight: bold;
    }
    .panel-body table tr:last-child td,
    .panel-body table tr:last-child th {
        border-bottom: none;
    }
    .explanation {
        margin-top: 25px;
    }
    .explanation li {
        margin-bottom: 12px;
    }

    /* Helper Classes */
    .clickable {
        cursor: pointer;
    }
    .d-none {
        display: none !important;
    }

    /* SVG Icons */
    .icon-metric { color: var(--metric-color); }
    .icon-dim { color: var(--dim-color); }
    .icon-system { color: var(--system-color); }
</style>
</head>
<body>

<!-- SVGs for icons -->
<svg style="display:none;">
    <symbol id="icon-search" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></symbol>
    <symbol id="icon-metric" viewBox="0 0 24 24" fill="currentColor"><path d="M21 7.24V16.76C21 17.5 20.5 18 20 18H4C3.5 18 3 17.5 3 16.76V7.24C3 6.5 3.5 6 4 6H20C20.5 6 21 6.5 21 7.24ZM12 17C14.76 17 17 14.76 17 12S14.76 7 12 7 7 9.24 7 12 9.24 17 12 17Z"/></symbol>
    <symbol id="icon-dim" viewBox="0 0 24 24" fill="currentColor"><path d="M4 18h17v-6H4v6zM4 5v6h17V5H4z"/></symbol>
    <symbol id="icon-system" viewBox="0 0 24 24" fill="currentColor"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24" fill="currentColor"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-1.01l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.28-1.17.61-1.69 1.01l-2.49-1c-.23-.08-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69 1.01l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.28 1.17-.61 1.69-1.01l2.49 1c.23.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></symbol>
</svg>

<div class="preview-container">
    <div class="main-tab-bar">
        <div class="main-tab-link active" onclick="openMainTab(event, 'tab-1')">1. Overview</div>
        <div class="main-tab-link" onclick="openMainTab(event, 'tab-2')">2. Datasets & Joins</div>
        <div class="main-tab-link" onclick="openMainTab(event, 'tab-3')">3. Connection Setup</div>
        <div class="main-tab-link" onclick="openMainTab(event, 'tab-4')">4. Data View Config</div>
        <div class="main-tab-link" onclick="openMainTab(event, 'tab-5')">5. Workspace Analysis</div>
    </div>

    <!-- ===== TAB 1: OVERVIEW ===== -->
    <div id="tab-1" class="main-tab-content main-tab-pane active">
        <h2>B2C Use Case: Loyalty Program Analysis</h2>
        <p>This prototype demonstrates a <strong>Profile-Only query</strong> for a B2C scenario.</p>
        
        <h3>Persona</h3>
        <p>Sarah, a Loyalty Program Manager at a national retailer.</p>

        <h3>Use Case</h3>
        <p>Sarah is planning for the upcoming holiday season. She needs a complete picture of her <em>entire</em> loyalty member base to budget for tier-specific perks and forecast potential revenue. She doesn't want to see <em>only</em> members who were active last month; she needs to see <em>everyone</em>.</p>
        
        <h3>Business Question</h3>
        <p><strong>"What is the total number of members and the total lifetime value (LTV) for <em>each</em> loyalty tier in our program?"</strong></p>

        <div class="info-box">
            <strong>Key Concept: Profile-Only Query</strong><br>
            This is a "Profile-Only" query because it runs directly against the profile dataset and its lookups. It does not involve *any* event data. Therefore, the query is <strong>time-insensitive</strong>; the reporting window is ignored, and the results represent the complete, current state of the profile data.
        </div>
    </div>

    <!-- ===== TAB 2: DATASETS & JOINS ===== -->
    <div id="tab-2" class="main-tab-content main-tab-pane">
        <h2>Datasets & Joins</h2>
        <p>To answer this question, we need two datasets. This is a B2C (person-based) connection.</p>

        <h3>1. CRM Profiles (Profile Dataset)</h3>
        <p>This is our primary <strong>Person</strong> dataset. It contains the master list of all known customers.</p>
        <table>
            <thead>
                <tr>
                    <th>person_id (Primary ID)</th>
                    <th>full_name</th>
                    <th>email</th>
                    <th>city</th>
                    <th>state</th>
                    <th>loyalty_id (Join Key)</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>p-101</td><td>Alex Johnson</td><td>alex@...</td><td>New York</td><td>NY</td><td>L-5001</td></tr>
                <tr><td>p-102</td><td>Beth Smith</td><td>beth@...</td><td>Chicago</td><td>IL</td><td>L-5002</td></tr>
                <tr><td>p-103</td><td>Carlos Gomez</td><td>carlos@...</td><td>Miami</td><td>FL</td><td>L-5003</td></tr>
                <tr><td>p-104</td><td>Dana White</td><td>dana@...</td><td>Chicago</td><td>IL</td><td>L-5004</td></tr>
                <tr><td>p-105</td><td>Evan Lee</td><td>evan@...</td><td>New York</td><td>NY</td><td>L-5005</td></tr>
            </tbody>
        </table>

        <h3>2. Loyalty Program Details (Lookup Dataset)</h3>
        <p>This is a <strong>Lookup</strong> dataset containing attributes for each loyalty ID.</p>
        <table>
            <thead>
                <tr>
                    <th>loyalty_id (Primary Key)</th>
                    <th>loyalty_tier</th>
                    <th>lifetime_value</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>L-5001</td><td>Gold</td><td>1200</td></tr>
                <tr><td>L-5002</td><td>Silver</td><td>650</td></tr>
                <tr><td>L-5003</td><td>Gold</td><td>1500</td></tr>
                <tr><td>L-5004</td><td>Bronze</td><td>150</td></tr>
                <tr><td>L-5005</td><td>Silver</td><td>800</td></tr>
            </tbody>
        </table>

        <h3>Required Join</h3>
        <p>We must join the <code>Loyalty Program Details</code> lookup to the <code>CRM Profiles</code> dataset.</p>
        <p><code>CRM Profiles</code>.<code>loyalty_id</code>  ➔  <code>Loyalty Program Details</code>.<code>loyalty_id</code></p>
    </div>

    <!-- ===== TAB 3: CONNECTION SETUP ===== -->
    <div id="tab-3" class="main-tab-content main-tab-pane">
        <div class="connection-container">
            <div class="connection-header">
                <h2>B2C Loyalty Connection</h2>
            </div>
            <div class="connection-body">
                <div class="connection-left-nav">
                    <div class="connection-nav-item" onclick="switchConnectionTab(event, 'conn-tab-event')">Event datasets</div>
                    <div class="connection-nav-item active" onclick="switchConnectionTab(event, 'conn-tab-profile')">Profile datasets</div>
                    <div class="connection-nav-item" onclick="switchConnectionTab(event, 'conn-tab-lookup')">Lookup datasets</div>
                </div>
                <div class="connection-main">
                    <!-- Profile Datasets Pane -->
                    <div id="conn-tab-profile" class="connection-pane active">
                        <h3>Profile datasets</h3>
                        <div class="dataset-card">
                            <div class="dataset-card-header">CRM Profiles</div>
                            <div class="dataset-card-body">
                                <div class="form-group">
                                    <label for="person-id">Person ID</label>
                                    <select id="person-id" disabled>
                                        <option selected>person_id</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Lookup Datasets Pane -->
                    <div id="conn-tab-lookup" class="connection-pane d-none">
                        <h3>Lookup datasets</h3>
                        <div class="info-box" style="font-size: 15px;">
                            <strong>Note:</strong> This UI is modeled on the B2C join experience. The <strong>Path name</strong> assigned here (e.g., "Loyalty Join") will be used in the Data View to differentiate fields from this specific join.
                        </div>
                        <div class="dataset-card">
                            <div class="dataset-card-header">Loyalty Program Details</div>
                            <div class="dataset-card-body">
                                <div class="join-pair-card">
                                    <div class="join-pair-header">
                                        <h4>Key pair #1</h4>
                                        <div class="path-name-group">
                                            <label for="path-name-1">Path name:</label>
                                            <input type="text" id="path-name-1" value="Loyalty Join">
                                        </div>
                                    </div>
                                    <div class="join-pair-body">
                                        <div class="radio-group">
                                            <label>
                                                <input type="radio" name="match-method-1" checked>
                                                <span class="radio-label">Match by <strong>field</strong></span>
                                            </label>
                                            <label>
                                                <input type="radio" name="match-method-1">
                                                <span class="radio-label">Match by <strong>container</strong> (defaults to Person)</span>
                                            </label>
                                        </div>
                                        <div class="key-pair-row">
                                            <div class="key-pair-col form-group">
                                                <label for="lookup-key-1">Key (from Loyalty Program Details)</label>
                                                <select id="lookup-key-1">
                                                    <option selected>loyalty_id</option>
                                                    <option>loyalty_tier</option>
                                                </select>
                                            </div>
                                            <div class="key-pair-col form-group">
                                                <label for="source-key-1">Matching key (from CRM Profiles)</label>
                                                <select id="source-key-1">
                                                    <option>person_id</option>
                                                    <option selected>loyalty_id</option>
                                                    <option>email</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <!-- NEW SECTION ADDED -->
                                        <hr style="border: none; border-top: 1px solid var(--adobe-gray-200); margin: 25px 0;">
                                        
                                        <div class="optimization-section">
                                            <div class="form-group" style="margin-bottom: 0;">
                                                <label for="optimize-person-id" style="font-weight: 600; font-size: 14px;">Optimization (optional)</label>
                                                <div style="display: flex; margin-top: 15px;">
                                                    <div style="flex: 0 1 50%; padding-right: 10px;">
                                                        <label for="optimize-person-id-label" style="font-weight: normal; font-size: 14px; margin-bottom: 8px;">Include Person ID field from this lookup</label>
                                                        <select id="optimize-person-id-label" class="form-group" style="margin-bottom: 0;">
                                                            <option selected>None</option>
                                                            <option>person_id_field_example</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- END NEW SECTION -->
                                    </div>
                                </div>
                                <!-- NEW BUTTON ADDED -->
                                <button class="button button-secondary" onclick="alert('This would add a new, empty key pair card.')" style="margin-top: 20px;">+ Add new pair</button>
                            </div>
                        </div>
                        <button class="button button-primary" onclick="alert('Connection saved (demo)')" style="margin-top: 20px;">Save connection</button>
                    </div>
                    <!-- Event Datasets Pane (Placeholder) -->
                    <div id="conn-tab-event" class="connection-pane d-none">
                        <h3>Event datasets</h3>
                        <p>No event datasets have been added for this Profile-Only use case.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== TAB 4: DATA VIEW CONFIG ===== -->
    <div id="tab-4" class="main-tab-content main-tab-pane">
        <div class="dv-container">
            <!-- Header -->
            <div class="dv-header">
                <div class="dv-header-title">Data views > <span>B2C Loyalty DV</span></div>
                <div class="dv-header-buttons">
                    <button class="button button-secondary">Close</button>
                    <button class="button button-secondary">Save</button>
                    <button class="button button-primary">Save and continue</button>
                </div>
            </div>
            <!-- Subnav -->
            <div class="dv-subnav">
                <div class="dv-subnav-item">Configure</div>
                <div class="dv-subnav-item active">Components</div>
                <div class="dv-subnav-item">Settings</div>
            </div>
            <!-- Body -->
            <div class="dv-body">
                <!-- Left Panel -->
                <div class="dv-left-panel">
                    <div class="dv-search-bar">
                        <svg><use href="#icon-search"></use></svg>
                        <input type="text" placeholder="Search components" onkeyup="filterComponents(this.value)">
                    </div>

                    <div class="dv-dataset-group expanded" data-group-id="group-system">
                        <h4 onclick="toggleDvGroup('group-system')">SYSTEM-GENERATED COMPONENTS</h4>
                        <div class="dv-component-list">
                            <div id="dv-comp-total-people" class="dv-component-item" data-name="Total People">
                                <svg class="icon icon-system"><use href="#icon-system"></use></svg>
                                <div class="component-text">
                                    <div class="component-name">Total People</div>
                                    <div class="component-path">System-Generated</div>
                                </div>
                                <button class="dv-add-btn" onclick="dvAddComponent('total-people')">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dv-dataset-group expanded" data-group-id="group-crm">
                        <h4 onclick="toggleDvGroup('group-crm')">CRM PROFILES (PROFILE)</h4>
                        <div class="dv-component-list">
                            <div id="dv-comp-state" class="dv-component-item" data-name="State">
                                <svg class="icon icon-dim"><use href="#icon-dim"></use></svg>
                                <div class="component-text">
                                    <div class="component-name">State</div>
                                </div>
                                <button class="dv-add-btn" onclick="dvAddComponent('state')">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="dv-dataset-group expanded" data-group-id="group-loyalty">
                        <h4 onclick="toggleDvGroup('group-loyalty')">LOYALTY PROGRAM DETAILS (LOOKUP)</h4>
                        <div class="dv-component-list">
                            <div id="dv-comp-ltv" class="dv-component-item" data-name="Lifetime Value">
                                <svg class="icon icon-metric"><use href="#icon-metric"></use></svg>
                                <div class="component-text">
                                    <div class="component-name">Lifetime Value</div>
                                </div>
                                <button class="dv-add-btn" onclick="dvAddComponent('ltv')">+</button>
                            </div>
                            <div id="dv-comp-tier" class="dv-component-item" data-name="Loyalty Tier">
                                <svg class="icon icon-dim"><use href="#icon-dim"></use></svg>
                                <div class="component-text">
                                    <div class="component-name">Loyalty Tier</div>
                                </div>
                                <button class="dv-add-btn" onclick="dvAddComponent('tier')">+</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Middle Panel -->
                <div class="dv-middle-panel">
                    <table id="dv-included-table">
                        <thead>
                            <tr>
                                <th>COMPONENT NAME</th>
                                <th>DATASET</th>
                                <th>SCHEMA PATH</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Components will be added here by JS -->
                        </tbody>
                    </table>
                </div>
                <!-- Right Panel -->
                <div class="dv-right-panel">
                    <div id="dv-settings-placeholder">
                        <div class="dv-right-panel-placeholder">
                            <svg><use href="#icon-settings"></use></svg>
                            <h4>Select a component</h4>
                            <p>Select a component or metric from the list to view the available settings.</p>
                        </div>
                    </div>
                    <div id="dv-settings-panel" class="d-none">
                        <!-- Settings will be injected here by JS -->
                    </div>
                </div>
            </div>
        </div>
        <div class="info-box" style="margin-top: 25px;">
            <strong>Your Goal:</strong>
            <ol>
                <li>In the left panel, click the <strong>'+'</strong> button next to <strong>Total People</strong>, <strong>Lifetime Value</strong>, and <strong>Loyalty Tier</strong>.</li>
                <li>In the middle panel, click the newly added <strong>Lifetime Value</strong> row.</li>
                <li>In the right panel, rename it to <strong>Total Lifetime Value</strong>.</li>
                <li>Set its <strong>Scope</strong> to <strong>Total Population (Profile-based)</strong>.</li>
                <li>Set its <strong>Behavior</strong> to <strong>Sum</strong> and click <strong>Save</strong>.</li>
            </ol>
        </div>
    </div>

    <!-- ===== TAB 5: WORKSPACE ANALYSIS ===== -->
    <div id="tab-5" class="main-tab-content main-tab-pane">
        <h2>Workspace Analysis</h2>
        <p>With the Data View configured, Sarah builds her report in Analysis Workspace.</p>
        
        <div class="workspace-ui">
            <div class="panel">
                <div class="panel-header">
                    <span class="date-range">
                        Date Range: Last 30 Days (<strong>Irrelevant for this Profile-Only Query</strong>)
                    </span>
                </div>
                <div class="panel-body">
                    <p>Sarah drags over the <code>Loyalty Tier</code> dimension and the two TPR metrics: <code>Total People</code> and <code>Total Lifetime Value</code>.</p>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Loyalty Tier</th>
                                <th>Total People (TPR)</th>
                                <th>Total Lifetime Value (TPR)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Gold</td><td>2</td><td>$2,700</td></tr>
                            <tr><td>Silver</td><td>2</td><td>$1,450</td></tr>
                            <tr><td>Bronze</td><td>1</td><td>$150</td></tr>
                            <tr>
                                <td><strong>Total</strong></td>
                                <td><strong>5</strong></td>
                                <td><strong>$4,300</strong></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="explanation">
                        <h3>How This Query Works (The Logic)</h3>
                        <p>This report is generated *without* looking at a single event dataset.</p>
                        <ol>
                            <li>
                                <strong>Dimension (<code>Loyalty Tier</code>):</strong> The system queries the <em>entire</em> <code>CRM Profiles</code> dataset (5 people total). It then follows the join path (<code>Loyalty Join</code>) to the <code>Loyalty Program Details</code> lookup to find the <code>loyalty_tier</code> for all 5 people.
                            </li>
                            <li>
                                <strong>Metric 1 (<code>Total People</code>):</strong> This system metric counts the unique <code>person_id</code>s found for each dimension item.
                                <ul>
                                    <li><strong>Gold:</strong> p-101, p-103 = <strong>2</strong> people</li>
                                    <li><strong>Silver:</strong> p-102, p-105 = <strong>2</strong> people</li>
                                    <li><strong>Bronze:</strong> p-104 = <strong>1</strong> person</li>
                                </ul>
                            </li>
                            <li>
                                <strong>Metric 2 (<code>Total Lifetime Value</code>):</strong> This is our custom TPR metric.
                                <ul>
                                    <li><strong>Scope:</strong> <code>Total Population</code> (queries all 5 profiles)</li>
                                    <li><strong>Behavior:</strong> <code>Sum</code></li>
                                </ul>
                                The system finds the <code>lifetime_value</code> for every person in the group (using the <code>Loyalty Join</code> path) and sums them:
                                <ul>
                                    <li><strong>Gold:</strong> $1,200 (from p-101) + $1,500 (from p-103) = <strong>$2,700</strong></li>
                                    <li><strong>Silver:</strong> $650 (from p-102) + $800 (from p-105) = <strong>$1,450</strong></li>
                                    <li><strong>Bronze:</strong> $150 (from p-104) = <strong>$150</strong></li>
                                </ul>
                            </li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
        <div class="info-box" style="margin-top: 25px;">
            <strong>Unlocked Business Value:</strong> Sarah now has a complete, holistic view of her entire loyalty program's value, not just the "active" slice. She can confidently budget for her Gold and Silver perks, knowing the exact size and value of those tiers. This was impossible before TPR, as any report would have excluded members with no recent events.
        </div>
    </div>
</div>

<script>
    // --- Main Tab Navigation ---
    function openMainTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("main-tab-pane");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("main-tab-link");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    // --- Tab 3: Connection Setup ---
    function switchConnectionTab(evt, tabId) {
        document.querySelectorAll('.connection-pane').forEach(p => p.classList.add('d-none'));
        document.querySelectorAll('.connection-nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById(tabId).classList.remove('d-none');
        evt.currentTarget.classList.add('active');
    }

    // --- Tab 4: Data View Config ---
    const dvState = {
        sourceComponents: {
            'total-people': { id: 'total-people', name: 'Total People', dataset: 'System', path: 'n/a', type: 'system', settings: { scope: 'Total Population (Profile-based)', behavior: 'Count Instances' } },
            'ltv': { id: 'ltv', name: 'Lifetime Value', dataset: 'Loyalty Program Details', path: 'Loyalty Program Details → Loyalty Join', type: 'metric', settings: { scope: 'Event-based (Occurrences)', behavior: 'Sum' } },
            'tier': { id: 'tier', name: 'Loyalty Tier', dataset: 'Loyalty Program Details', path: 'Loyalty Program Details → Loyalty Join', type: 'dim', settings: {} },
            'state': { id: 'state', name: 'State', dataset: 'CRM Profiles', path: 'CRM Profiles', type: 'dim', settings: {} }
        },
        includedComponents: [], // This will hold instances
        selectedInstanceId: null,
        componentCounter: 0 // Simpler, just a global counter
    };

    function filterComponents(value) {
        const searchTerm = value.toLowerCase();
        document.querySelectorAll('.dv-component-item').forEach(item => {
            const name = item.getAttribute('data-name').toLowerCase();
            if (name.includes(searchTerm)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function toggleDvGroup(groupId) {
        document.querySelector(`.dv-dataset-group[data-group-id='${groupId}']`).classList.toggle('expanded');
    }

    function dvAddComponent(id) {
        const sourceComp = dvState.sourceComponents[id];
        if (!sourceComp) return;

        dvState.componentCounter++;
        const instanceId = `${id}-${dvState.componentCounter}`;
        
        // Create a deep copy of the component and its settings
        const newInstance = JSON.parse(JSON.stringify(sourceComp)); // deep copy
        
        newInstance.instanceId = instanceId; // Add the unique instance ID
        
        dvState.includedComponents.push(newInstance);
        renderDataView();
        dvSelectComponent(instanceId); // Auto-select the newly added component
    }

    function dvSelectComponent(id) {
        dvState.selectedInstanceId = id;
        renderDataView();
    }

    function dvSaveSettings() {
        const id = dvState.selectedInstanceId;
        if (!id) return;
        
        // Find the component in the includedComponents array
        const comp = dvState.includedComponents.find(c => c.instanceId === id);
        if (!comp) return;

        comp.name = document.getElementById('setting-name').value;
        
        if(comp.type === 'metric' || comp.type === 'system') {
            comp.settings.scope = document.getElementById('setting-scope').value;
            comp.settings.behavior = document.getElementById('setting-behavior').value;
        }
        
        dvState.selectedInstanceId = null; // Deselect after saving
        renderDataView();
        alert('Settings saved!');
    }

    function renderDataView() {
        // Render Left Panel (Available)
        Object.keys(dvState.sourceComponents).forEach(id => {
            const el = document.getElementById(`dv-comp-${id}`);
            el.classList.remove('added'); // Ensure it's never grayed out
        });

        // Render Middle Panel (Included)
        const tableBody = document.querySelector('#dv-included-table tbody');
        tableBody.innerHTML = '';
        dvState.includedComponents.forEach(comp => {
            const row = document.createElement('tr');
            row.onclick = () => dvSelectComponent(comp.instanceId); // Use instanceId
            if (comp.instanceId === dvState.selectedInstanceId) { // Use instanceId
                row.classList.add('selected');
            }
            
            let iconSvg = '';
            if(comp.type === 'metric') iconSvg = `<svg class="icon icon-metric"><use href="#icon-metric"></use></svg>`;
            else if(comp.type === 'dim') iconSvg = `<svg class="icon icon-dim"><use href="#icon-dim"></use></svg>`;
            else if(comp.type === 'system') iconSvg = `<svg class="icon icon-system"><use href="#icon-system"></use></svg>`;

            row.innerHTML = `
                <td>${iconSvg} <span class="component-name">${comp.name}</span></td>
                <td>${comp.dataset}</td>
                <td>${comp.path}</td>
            `;
            tableBody.appendChild(row);
        });

        // Render Right Panel (Settings)
        const placeholder = document.getElementById('dv-settings-placeholder');
        const settingsPanel = document.getElementById('dv-settings-panel');
        if (!dvState.selectedInstanceId) { // Use selectedInstanceId
            placeholder.classList.remove('d-none');
            settingsPanel.classList.add('d-none');
            settingsPanel.innerHTML = '';
        } else {
            placeholder.classList.add('d-none');
            settingsPanel.classList.remove('d-none');
            
            // Find the selected component from the includedComponents array
            const comp = dvState.includedComponents.find(c => c.instanceId === dvState.selectedInstanceId);
            if (!comp) return; // Should not happen

            let settingsHtml = `
                <div class="dv-right-panel-settings">
                    <h3>Component settings</h3>
                    <div class="form-group">
                        <label for="setting-name">NAME</label>
                        <input type="text" id="setting-name" value="${comp.name}">
                    </div>
            `;
            
            if(comp.type === 'metric' || comp.type === 'system') {
                const isSystem = comp.type === 'system';
                settingsHtml += `
                    <div class="form-group">
                        <label for="setting-scope">SCOPE</label>
                        <select id="setting-scope" ${isSystem ? 'disabled' : ''}>
                            <option value="Event-based (Occurrences)" ${comp.settings.scope === 'Event-based (Occurrences)' ? 'selected' : ''}>Event-based (Occurrences)</option>
                            <option value="Total Population (Profile-based)" ${comp.settings.scope === 'Total Population (Profile-based)' ? 'selected' : ''}>Total Population (Profile-based)</option>
                        </select>
                        ${comp.type === 'metric' ? '<small style="color: #555; font-size: 13px;">Select "Total Population" to query all profiles, ignoring events.</small>' : ''}
                        ${isSystem ? '<div class="info-box" style="padding: 10px; font-size: 13px; margin-top: 10px;"><strong>System Metric:</strong> Scope is locked for system-generated TPR metrics.</div>' : ''}
                    </div>
                    <div class="form-group">
                        <label for="setting-behavior">BEHAVIOR</label>
                        <select id="setting-behavior" ${isSystem ? 'disabled' : ''}>
                            <option value="Sum" ${comp.settings.behavior === 'Sum' ? 'selected' : ''}>Sum</option>
                            <option value="Count Instances" ${comp.settings.behavior === 'Count Instances' ? 'selected' : ''}>Count Instances</option>
                            <option value="Average" ${comp.settings.behavior === 'Average' ? 'selected' : ''}>Average</option>
                            <option value="Min" ${comp.settings.behavior === 'Min' ? 'selected' : ''}>Min</option>
                            <option value="Max" ${comp.settings.behavior === 'Max' ? 'selected' : ''}>Max</option>
                        </select>
                    </div>
                `;
            }

            settingsHtml += `
                    <button class="button button-primary" onclick="dvSaveSettings()">Save</button>
                </div>
            `;
            settingsPanel.innerHTML = settingsHtml;
        }
    }

    // Initial render
    document.addEventListener("DOMContentLoaded", function() {
        openMainTab({currentTarget: document.querySelector('.main-tab-link.active')}, 'tab-1');
        renderDataView();
    });
</script>

</body>
</html>



