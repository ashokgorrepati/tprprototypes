<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    /* Adobe-inspired palette and global styles */
    :root {
        --adobe-blue: #0265dc;
        --adobe-blue-hover: #0052b3;
        --adobe-gray-50: #fafafa;
        --adobe-gray-100: #f4f4f4;
        --adobe-gray-200: #eaeaea;
        --adobe-gray-300: #e3e3e3;
        --adobe-gray-400: #d3d3d3;
        --adobe-gray-500: #cacaca;
        --adobe-gray-600: #b2b2b2;
        --adobe-gray-700: #8e8e8e;
        --adobe-gray-800: #505050;
        --adobe-gray-900: #323232;
        --text-color: #4b4b4b;
        --metric-color: #e67e22;
        --dim-color: #0c84e8;
        --system-color: #6c757d;
        --radio-checked-color: var(--adobe-blue);
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background-color: var(--adobe-gray-100);
        color: var(--text-color);
        margin: 0;
        padding: 0;
    }
    .preview-container {
        max-width: 1400px;
        margin: 20px auto;
        background: #fff;
        border: 1px solid var(--adobe-gray-300);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    
    /* Main Tab Navigation */
    .main-tab-bar {
        display: flex;
        background-color: var(--adobe-gray-50);
        border-bottom: 1px solid var(--adobe-gray-300);
        padding: 0 20px;
    }
    .main-tab-link {
        padding: 16px 20px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        font-weight: 600;
        color: var(--adobe-gray-700);
        font-size: 16px;
        transition: all 0.2s ease;
        margin-right: 10px;
    }
    .main-tab-link:hover {
        background-color: var(--adobe-gray-100);
        color: var(--adobe-blue);
    }
    .main-tab-link.active {
        border-bottom-color: var(--adobe-blue);
        color: var(--adobe-blue);
        background-color: #fff;
    }
    .main-tab-content {
        padding: 25px;
        min-height: 650px;
    }
    .main-tab-pane {
        display: none;
    }
    .main-tab-pane.active {
        display: block;
    }

    /* General Content Styling */
    h2 {
        color: #000;
        border-bottom: 1px solid var(--adobe-gray-200);
        padding-bottom: 10px;
        margin-top: 0;
        font-size: 24px;
        font-weight: 400;
    }
    h3 {
        color: var(--adobe-gray-900);
        margin-top: 25px;
        margin-bottom: 10px;
        font-size: 18px;
        font-weight: 600;
    }
    p, li {
        font-size: 16px;
        line-height: 1.6;
    }
    code {
        background-color: #eef;
        padding: 3px 6px;
        border-radius: 4px;
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    }
    .info-box {
        background-color: #f4f8ff;
        border: 1px solid #c9ddff;
        border-left: 4px solid var(--adobe-blue);
        padding: 15px 20px;
        margin: 20px 0;
        border-radius: 5px;
    }
    .info-box strong {
        color: #0056b3;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border: 1px solid var(--adobe-gray-300);
        border-radius: 6px;
        overflow: hidden;
    }
    th, td {
        border-bottom: 1px solid var(--adobe-gray-300);
        padding: 12px 15px;
        text-align: left;
    }
    th {
        background-color: var(--adobe-gray-50);
        font-weight: 600;
        font-size: 14px;
    }
    tbody tr:last-child th,
    tbody tr:last-child td {
        border-bottom: none;
    }
    tr:nth-child(even) {
        background-color: var(--adobe-gray-50);
    }

    /* Spectrum-like Button */
    .button {
        padding: 8px 16px;
        font-size: 15px;
        font-weight: 600;
        border-radius: 16px; /* Pill shape */
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
        line-height: 1.5;
    }
    .button-primary {
        background-color: var(--adobe-blue);
        color: #fff;
        border-color: var(--adobe-blue);
    }
    .button-primary:hover { 
        background-color: var(--adobe-blue-hover); 
        border-color: var(--adobe-blue-hover);
    }
    .button-secondary {
        background-color: #fff;
        color: var(--adobe-gray-800);
        border-color: var(--adobe-gray-400);
    }
    .button-secondary:hover { 
        background-color: var(--adobe-gray-100);
        border-color: var(--adobe-gray-600);
    }

    /* --- Tab 3: Connection Setup --- */
    .connection-container {
        border: 1px solid var(--adobe-gray-400);
        border-radius: 6px;
        background: #fff;
        min-height: 600px;
    }
    .connection-header {
        padding: 12px 20px;
        background: var(--adobe-gray-50);
        border-bottom: 1px solid var(--adobe-gray-300);
    }
    .connection-header h2 {
        font-size: 20px;
        font-weight: 600;
        margin: 0;
        padding: 0;
        border: none;
        color: var(--adobe-gray-900);
    }
    .connection-body {
        display: flex;
    }
    .connection-left-nav {
        width: 250px;
        border-right: 1px solid var(--adobe-gray-300);
        padding: 20px 0;
        background: var(--adobe-gray-50);
    }
    .connection-nav-item {
        padding: 12px 20px;
        font-weight: 500;
        color: var(--adobe-gray-800);
        cursor: pointer;
        border-left: 3px solid transparent;
    }
    .connection-nav-item:hover {
        background: var(--adobe-gray-100);
        color: var(--adobe-blue);
    }
    .connection-nav-item.active {
        background: #fff;
        color: var(--adobe-blue);
        border-left-color: var(--adobe-blue);
        font-weight: 600;
    }
    .connection-main {
        flex: 1;
        padding: 25px;
        overflow-x: auto;
    }
    .connection-main h3 {
        font-size: 20px;
        font-weight: 600;
        margin-top: 0;
    }
    .dataset-card {
        border: 1px solid var(--adobe-gray-400);
        border-radius: 6px;
        margin-bottom: 20px;
    }
    .dataset-card-header {
        padding: 15px 20px;
        background: var(--adobe-gray-50);
        border-bottom: 1px solid var(--adobe-gray-300);
        font-weight: 600;
    }
    .dataset-card-body {
        padding: 20px;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 8px;
    }
    .form-group select, .form-group input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--adobe-gray-400);
        border-radius: 4px;
        box-sizing: border-box; 
        font-size: 15px;
    }

    /* --- Tab 4: Data View Config --- */
    .dv-container {
        border: 1px solid var(--adobe-gray-300);
        background: #fff;
        height: 700px;
        display: flex;
        flex-direction: column;
    }
    .dv-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 20px;
        border-bottom: 1px solid var(--adobe-gray-300);
        background: var(--adobe-gray-50);
    }
    .dv-header-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--adobe-gray-800);
    }
    .dv-header-title span {
        color: var(--adobe-gray-900);
        font-weight: 700;
    }
    .dv-header-buttons {
        display: flex;
        gap: 10px;
    }
    .dv-subnav {
        display: flex;
        padding: 0 20px;
        border-bottom: 1px solid var(--adobe-gray-300);
    }
    .dv-subnav-item {
        padding: 12px 16px;
        font-weight: 600;
        color: var(--adobe-gray-700);
        border-bottom: 3px solid transparent;
        cursor: pointer;
    }
    .dv-subnav-item.active {
        color: var(--adobe-blue);
        border-bottom-color: var(--adobe-blue);
    }
    .dv-body {
        display: flex;
        flex: 1;
        overflow: hidden;
    }
    .dv-left-panel {
        width: 25%;
        border-right: 1px solid var(--adobe-gray-300);
        padding: 20px;
        overflow-y: auto;
        background: var(--adobe-gray-50);
        min-width: 250px;
    }
    .dv-middle-panel {
        width: 45%;
        border-right: 1px solid var(--adobe-gray-300);
        overflow-y: auto;
        min-width: 300px;
    }
    .dv-right-panel {
        width: 30%;
        overflow-y: auto;
        background: var(--adobe-gray-50);
        min-width: 250px;
    }
    .dv-search-bar {
        position: relative;
        margin-bottom: 20px;
    }
    .dv-search-bar input {
        width: 100%;
        padding: 10px 10px 10px 35px;
        border-radius: 4px;
        border: 1px solid var(--adobe-gray-400);
        box-sizing: border-box;
    }
    .dv-search-bar svg {
        position: absolute;
        left: 10px;
        top: 11px;
        width: 16px;
        height: 16px;
        color: var(--adobe-gray-700);
    }
    .dv-dataset-group h4 {
        margin: 20px 0 10px;
        font-size: 14px;
        font-weight: 600;
        color: var(--adobe-gray-800);
        cursor: pointer;
        display: flex;
        align-items: center;
    }
    .dv-dataset-group h4::before {
        content: 'â–º';
        font-size: 10px;
        margin-right: 8px;
        transition: transform 0.2s;
    }
    .dv-dataset-group.expanded h4::before {
        transform: rotate(90deg);
    }
    
    .dv-component-list {
        padding-left: 10px;
        display: none; /* Hidden by default */
    }
    .dv-dataset-group.expanded .dv-component-list {
        display: block; /* Show when group is open */
    }
    
    .dv-component-item {
        display: flex;
        align-items: center;
        padding: 8px;
        margin-bottom: 5px;
        border-radius: 4px;
    }
    .dv-component-item .icon {
        width: 24px;
        height: 24px;
        margin-right: 8px;
        flex-shrink: 0;
    }
    .dv-component-item .component-text {
        flex: 1;
        min-width: 0;
    }
    .dv-component-item .component-name {
        font-weight: 500;
        font-size: 15px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .dv-component-item .component-path {
        font-size: 13px;
        color: var(--adobe-gray-700);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .dv-add-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 1px solid var(--adobe-gray-400);
        background: #fff;
        color: var(--adobe-gray-700);
        font-size: 20px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 28px;
        transition: all 0.2s;
        flex-shrink: 0;
    }
    .dv-add-btn:hover {
        border-color: var(--adobe-blue);
        color: var(--adobe-blue);
    }

    .dv-middle-panel table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
        border: none;
        box-shadow: none;
        border-radius: 0;
    }
    .dv-middle-panel th {
        font-size: 12px;
        font-weight: 600;
        color: var(--adobe-gray-700);
        text-transform: uppercase;
        padding: 10px 15px;
    }
    .dv-middle-panel td {
        padding: 12px 15px;
        font-size: 15px;
    }
    .dv-middle-panel tbody tr {
        cursor: pointer;
    }
    .dv-middle-panel tbody tr:hover {
        background: #f4f8ff;
    }
    .dv-middle-panel tbody tr.selected {
        background: #e6f2ff;
        border-left: 3px solid var(--adobe-blue);
    }
    .dv-middle-panel .icon {
        width: 20px;
        height: 20px;
        margin-right: 8px;
        vertical-align: middle;
    }
    .dv-middle-panel .component-name {
        font-weight: 500;
    }
    .dv-right-panel-placeholder {
        padding: 40px;
        text-align: center;
        color: var(--adobe-gray-700);
    }
    .dv-right-panel-placeholder svg {
        width: 60px;
        height: 60px;
        color: var(--adobe-gray-400);
        margin-bottom: 20px;
    }
    .dv-right-panel-settings {
        padding: 25px;
    }
    .dv-right-panel-settings h3 {
        font-size: 18px;
        font-weight: 600;
        margin-top: 0;
    }
    .dv-right-panel-settings .form-group label {
        font-size: 12px;
        text-transform: uppercase;
        color: var(--adobe-gray-700);
    }

    /* --- Tab 5: Workspace Analysis --- */
    .workspace-ui {
        background: var(--adobe-gray-100);
        border: 1px solid var(--adobe-gray-300);
        border-radius: 6px;
        padding: 20px;
    }
    .panel {
        background: #fff;
        border-radius: 6px;
        box-shadow: 0 3px 8px rgba(0,0,0,0.08);
        border: 1px solid var(--adobe-gray-300);
    }
    .panel-header {
        padding: 12px 20px;
        border-bottom: 1px solid var(--adobe-gray-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }
    .panel-title {
        font-size: 18px;
        font-weight: 600;
    }
    .panel-header .date-range {
        font-size: 14px;
        color: var(--adobe-gray-800);
        background: var(--adobe-gray-100);
        padding: 5px 10px;
        border-radius: 4px;
    }
    .panel-body {
        padding: 20px;
        overflow-x: auto; /* Added for table responsiveness */
    }
    .panel-body table {
        border: none;
        box-shadow: none;
    }
    .panel-body table th {
        background-color: var(--adobe-gray-100);
    }
    .panel-body table th, .panel-body table td {
        text-align: right;
        padding: 14px;
    }
    .panel-body table th:first-child,
    .panel-body table td:first-child {
        text-align: left;
        font-weight: 600;
    }
    .panel-body table tr:last-child {
        background-color: var(--adobe-gray-100);
        font-weight: bold;
    }
    .panel-body table tr:last-child td,
    .panel-body table tr:last-child th {
        border-bottom: none;
    }
    .explanation {
        margin-top: 25px;
    }
    .explanation li {
        margin-bottom: 12px;
    }
    
    /* Segment Builder Mock */
    .segment-builder {
        border: 1px solid var(--adobe-gray-300);
        border-radius: 6px;
        background: #fff;
        margin-top: 20px;
    }
    .segment-header {
        padding: 12px 20px;
        background: var(--adobe-gray-100);
        border-bottom: 1px solid var(--adobe-gray-300);
    }
    .segment-header h4 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
    }
    .segment-body {
        padding: 20px;
    }
    .segment-container {
        border: 1px dashed var(--adobe-gray-500);
        border-radius: 4px;
        padding: 15px;
        background: var(--adobe-gray-50);
    }
    .segment-container-header {
        font-size: 12px;
        font-weight: 600;
        color: var(--adobe-gray-700);
        text-transform: uppercase;
        margin-bottom: 15px;
    }
    .segment-rule {
        background: #fff;
        border: 1px solid var(--adobe-gray-300);
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 10px;
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    }
    .segment-rule strong {
        color: var(--adobe-blue);
    }
    .segment-or {
        font-weight: 600;
        color: var(--adobe-gray-800);
        margin: 10px 0;
    }

    /* Helper Classes */
    .clickable {
        cursor: pointer;
    }
    .d-none {
        display: none !important;
    }

    /* SVG Icons */
    .icon-metric { color: var(--metric-color); }
    .icon-dim { color: var(--dim-color); }
    .icon-system { color: var(--system-color); }
</style>
</head>
<body>

<!-- SVGs for icons -->
<svg style="display:none;">
    <symbol id="icon-search" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></symbol>
    <symbol id="icon-metric" viewBox="0 0 24 24" fill="currentColor"><path d="M21 7.24V16.76C21 17.5 20.5 18 20 18H4C3.5 18 3 17.5 3 16.76V7.24C3 6.5 3.5 6 4 6H20C20.5 6 21 6.5 21 7.24ZM12 17C14.76 17 17 14.76 17 12S14.76 7 12 7 7 9.24 7 12 9.24 17 12 17Z"/></symbol>
    <symbol id="icon-dim" viewBox="0 0 24 24" fill="currentColor"><path d="M4 18h17v-6H4v6zM4 5v6h17V5H4z"/></symbol>
    <symbol id="icon-system" viewBox="0 0 24 24" fill="currentColor"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24" fill="currentColor"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-1.01l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.28-1.17.61-1.69 1.01l-2.49-1c-.23-.08-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19-.15-.24-.42-.12-.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69 1.01l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38 2.65c.61-.28 1.17-.61 1.69-1.01l2.49 1c.23.08.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></symbol>
</svg>

<div class="preview-container">
    <div class="main-tab-bar">
        <div class="main-tab-link active" onclick="openMainTab(event, 'tab-1')">1. Overview</div>
        <div class="main-tab-link" onclick="openMainTab(event, 'tab-2')">2. Datasets & Joins</div>
        <div class="main-tab-link" onclick="openMainTab(event, 'tab-3')">3. Connection Setup</div>
        <div class="main-tab-link" onclick="openMainTab(event, 'tab-4')">4. Data View Config</div>
        <div class="main-tab-link" onclick="openMainTab(event, 'tab-5')">5. Workspace Analysis</div>
    </div>

    <!-- ===== TAB 1: OVERVIEW ===== -->
    <div id="tab-1" class="main-tab-content main-tab-pane active">
        <h2>B2C Use Case: Profile+Event (Union Query)</h2>
        <p>This prototype demonstrates a <strong>Profile+Event Union query</strong> for a B2C scenario, as defined by the architect.</p>
        
        <h3>Persona</h3>
        <p>A Marketing Manager.</p>

        <h3>Use Case</h3>
        <p>The marketing manager needs to build a single, comprehensive audience for a new premium campaign. This audience must include all "high-value" individuals, who are defined in two separate ways: their *static profile status* OR their *recent event behavior*.</p>
        
        <h3>Business Question</h3>
        <p><strong>"I need a single audience of people who are *either* 'Gold' loyalty members *or* made a purchase over $500 in the last 30 days. What is the total, deduplicated count of people in this 'High-Value Audience'?"</strong></p>

        <div class="info-box">
            <strong>Key Concept: Profile+Event (Union Query)</strong><br>
            This query performs a <strong>Full Outer Join</strong>. It combines the list of all people from the Profile dataset with the list of all people from the Event dataset (within the panel's date range). A segment is then applied to this "union" of people to find those who match *either* a profile rule (<code>Loyalty Tier = Gold</code>) *or* an event rule (<code>Purchase Value > 500</code>).
        </div>
    </div>

    <!-- ===== TAB 2: DATASETS & JOINS ===== -->
    <div id="tab-2" class="main-tab-content main-tab-pane">
        <h2>Datasets & Joins</h2>
        <p>This query requires a standard B2C connection with one event dataset and one profile dataset.</p>

        <h3>1. Event Dataset</h3>
        <p>Contains all web and purchase events. Note that `p-901` does not exist in the profiles.</p>
        <table>
            <thead>
                <tr>
                    <th>timestamp</th>
                    <th>person_id</th>
                    <th>event_type</th>
                    <th>purchase_value</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>(Last 30 days)</td><td>p-101</td><td>page_view</td><td>0</td></tr>
                <tr><td>(Last 30 days)</td><td>p-103</td><td>purchase</td><td>650</td></tr>
                <tr><td>(Last 30 days)</td><td>p-901</td><td>purchase</td><td>700</td></tr>
            </tbody>
        </table>

        <h3>2. CRM Profiles (Profile Dataset)</h3>
        <p>Contains the master list of all known customers. Note that `p-102` has no events in the last 30 days.</p>
        <table>
            <thead>
                <tr>
                    <th>person_id (Primary ID)</th>
                    <th>full_name</th>
                    <th>loyalty_tier</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>p-101</td><td>Alex Johnson</td><td>Gold</td></tr>
                <tr><td>p-102</td><td>Beth Smith</td><td>Gold</td></tr>
                <tr><td>p-103</td><td>Carlos Gomez</td><td>Silver</td></tr>
                <tr><td>p-104</td><td>Dana White</td><td>Bronze</td></tr>
            </tbody>
        </table>

        <h3>Required Joins</h3>
        <ol>
            <li>`Event Dataset` is added on the "Event datasets" tab, with its `person_id` mapped to the `Person` container.</li>
            <li>`CRM Profiles` is added on the "Profile datasets" tab, joined on `person_id`.</li>
        </ol>
    </div>

    <!-- ===== TAB 3: CONNECTION SETUP ===== -->
    <div id="tab-3" class="main-tab-content main-tab-pane">
        <div class="connection-container">
            <div class="connection-header">
                <h2>B2C Main Connection</h2>
            </div>
            <div class="connection-body">
                <div class="connection-left-nav">
                    <div class="connection-nav-item active" onclick="switchConnectionTab(event, 'conn-tab-event')">Event datasets</div>
                    <div class="connection-nav-item" onclick="switchConnectionTab(event, 'conn-tab-profile')">Profile datasets</div>
                    <div class="connection-nav-item" onclick="switchConnectionTab(event, 'conn-tab-lookup')">Lookup datasets</div>
                </div>
                <div class="connection-main">
                    <!-- Event Datasets Pane -->
                    <div id="conn-tab-event" class="connection-pane active">
                        <h3>Event datasets</h3>
                        <div class="dataset-card">
                            <div class="dataset-card-header">Web and Purchase Events</div>
                            <div class="dataset-card-body">
                                <div class="form-group">
                                    <label for="person-id">Person ID</label>
                                    <select id="person-id" disabled>
                                        <option selected>person_id</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Profile Datasets Pane -->
                    <div id="conn-tab-profile" class="connection-pane d-none">
                        <h3>Profile datasets</h3>
                        <div class="dataset-card">
                            <div class="dataset-card-header">CRM Profiles</div>
                            <div class="dataset-card-body">
                                <div class="form-group">
                                    <label for="profile-person-id">Person ID</label>
                                    <select id="profile-person-id" disabled>
                                        <option selected>person_id</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Lookup Datasets Pane -->
                    <div id="conn-tab-lookup" class="connection-pane d-none">
                        <h3>Lookup datasets</h3>
                        <p>No additional lookup datasets are required for this query.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== TAB 4: DATA VIEW CONFIG ===== -->
    <div id="tab-4" class="main-tab-content main-tab-pane">
        <div class="dv-container">
            <!-- Header -->
            <div class="dv-header">
                <div class="dv-header-title">Data views > <span>B2C Main DV</span></div>
                <div class="dv-header-buttons">
                    <button class="button button-secondary">Close</button>
                    <button class="button button-secondary">Save</button>
                    <button class="button button-primary">Save and continue</button>
                </div>
            </div>
            <!-- Subnav -->
            <div class="dv-subnav">
                <div class="dv-subnav-item">Configure</div>
                <div class="dv-subnav-item active">Components</div>
                <div class="dv-subnav-item">Settings</div>
            </div>
            <!-- Body -->
            <div class="dv-body">
                <!-- Left Panel -->
                <div class="dv-left-panel">
                    <div class="dv-search-bar">
                        <svg><use href="#icon-search"></use></svg>
                        <input type="text" placeholder="Search components" onkeyup="filterComponents(this.value)">
                    </div>

                    <div class="dv-dataset-group expanded" data-group-id="group-system">
                        <h4 onclick="toggleDvGroup('group-system')">SYSTEM-GENERATED COMPONENTS</h4>
                        <div class="dv-component-list">
                            <div id="dv-comp-total-people" class="dv-component-item" data-name="Total People">
                                <svg class="icon icon-system"><use href="#icon-system"></use></svg>
                                <div class="component-text">
                                    <div class="component-name">Total People</div>
                                    <div class="component-path">System-Generated (Profile-Only)</div>
                                </div>
                                <button class="dv-add-btn" onclick="dvAddComponent('total-people', 'system')">+</button>
                            </div>
                            <div id="dv-comp-total-people-union" class="dv-component-item" data-name="Total People (Union)">
                                <svg class="icon icon-system"><use href="#icon-system"></use></svg>
                                <div class="component-text">
                                    <div class="component-name">Total People (Union)</div>
                                    <div class="component-path">System-Generated (Profile+Event)</div>
                                </div>
                                <button class="dv-add-btn" onclick="dvAddComponent('total-people-union', 'system')">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dv-dataset-group expanded" data-group-id="group-profile">
                        <h4 onclick="toggleDvGroup('group-profile')">CRM PROFILES (PROFILE)</h4>
                        <div class="dv-component-list">
                            <div id="dv-comp-name" class="dv-component-item" data-name="Full Name">
                                <svg class="icon icon-dim"><use href="#icon-dim"></use></svg>
                                <div class="component-text">
                                    <div class="component-name">Full Name</div>
                                </div>
                                <button class="dv-add-btn" onclick="dvAddComponent('name', 'profile')">+</button>
                            </div>
                            <div id="dv-comp-tier" class="dv-component-item" data-name="Loyalty Tier">
                                <svg class="icon icon-dim"><use href="#icon-dim"></use></svg>
                                <div class="component-text">
                                    <div class="component-name">Loyalty Tier</div>
                                </div>
                                <button class="dv-add-btn" onclick="dvAddComponent('tier', 'profile')">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="dv-dataset-group expanded" data-group-id="group-event">
                        <h4 onclick="toggleDvGroup('group-event')">WEB AND PURCHASE EVENTS (EVENT)</h4>
                        <div class="dv-component-list">
                            <div id="dv-comp-purchase-value" class="dv-component-item" data-name="Purchase Value">
                                <svg class="icon icon-metric"><use href="#icon-metric"></use></svg>
                                <div class="component-text">
                                    <div class="component-name">Purchase Value</div>
                                </div>
                                <button class="dv-add-btn" onclick="dvAddComponent('purchase-value', 'event')">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-box" style="margin-top: 30px;">
                        <strong>New System Metrics Explained</strong>
                        <p style="font-size: 14px; line-height: 1.5;">
                            <strong>Total People:</strong> A <strong>Profile-Only</strong> metric. Counts all people in your Profile dataset, ignoring events and date ranges.
                            <br><br>
                            <strong>Total People (Union):</strong> A <strong>Profile+Event</strong> metric. Counts all unique people found in <strong>EITHER</strong> the Profile dataset <strong>OR</strong> the Event data (within the panel's date range). This performs a "Full Outer Join".
                        </p>
                    </div>

                </div>
                <!-- Middle Panel -->
                <div class="dv-middle-panel">
                    <table id="dv-included-table">
                        <thead>
                            <tr>
                                <th>COMPONENT NAME</th>
                                <th>DATASET</th>
                                <th>SCHEMA PATH</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Components will be added here by JS -->
                        </tbody>
                    </table>
                </div>
                <!-- Right Panel -->
                <div class="dv-right-panel">
                    <div id="dv-settings-placeholder">
                        <div class="dv-right-panel-placeholder">
                            <svg><use href="#icon-settings"></use></svg>
                            <h4>Select a component</h4>
                            <p>Select a component or metric from the list to view the available settings.</p>
                        </div>
                    </div>
                    <div id="dv-settings-panel" class="d-none">
                        <!-- Settings will be injected here by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== TAB 5: WORKSPACE ANALYSIS ===== -->
    <div id="tab-5" class="main-tab-content main-tab-pane">
        <h2>Workspace Analysis</h2>
        <p>The Marketing Manager first builds a standard `Person` segment with "OR" logic, then applies it to the new `Total People (Union)` metric.</p>
        
        <h3>Step 1: Build the "High-Value Audience" Segment</h3>
        <div class="segment-builder">
            <div class="segment-header">
                <h4>Segment: [High-Value Audience]</h4>
            </div>
            <div class="segment-body">
                <div class="segment-container">
                    <div class="segment-container-header">Person</div>
                    <div class="segment-rule">
                        <strong>Loyalty Tier</strong> (Profile Dim) <strong>Equals</strong> 'Gold'
                    </div>
                    <div class="segment-or">OR</div>
                    <div class="segment-rule">
                        <strong>Purchase Value</strong> (Event Metric) <strong>Is greater than</strong> 500
                    </div>
                </div>
            </div>
        </div>

        <h3 style="margin-top: 30px;">Step 2: Apply Segment to the "Union" Metric</h3>
        <div class="workspace-ui">
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">Total High-Value Audience</span>
                    <span class="date-range">
                        Date Range: Last 30 Days
                    </span>
                </div>
                <div class="panel-body">
                    <p>Apply the <strong>[High-Value Audience]</strong> segment to the <strong>Total People (Union)</strong> metric.</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Total People (Union)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>[High-Value Audience]</strong></td>
                                <td><strong>4</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <h3 style="margin-top: 30px;">Step 3: Analyze the "Union" Audience Breakdown</h3>
        <div class="workspace-ui">
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">Audience Breakdown</span>
                    <span class="date-range">
                        Date Range: Last 30 Days
                    </span>
                </div>
                <div class="panel-body">
                    <p>To see *who* is in this audience, we break down the <strong>Total People (Union)</strong> metric by the <strong>Full Name</strong> (Profile) dimension.</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Full Name (Profile)</th>
                                <th>Total People (Union)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Alex Johnson</td><td>1</td></tr>
                            <tr><td>Beth Smith</td><td>1</td></tr>
                            <tr><td>Carlos Gomez</td><td>1</td></tr>
                            <tr><td><strong>Name Unavailable (person_id: p-901)</strong></td><td><strong>1</strong></td></tr>
                            <tr>
                                <td><strong>Total</strong></td>
                                <td><strong>4</strong></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="explanation">
                        <h3>How This Query Works (The Logic)</h3>
                        <p>The table above proves the <strong>Full Outer Join</strong>. The segment (Gold OR >$500) was applied to the *combined* list of all people from profiles and events.</p>
                        <ol>
                            <li>
                                <strong>Alex Johnson (p-101):</strong> Matched.
                                <ul><li>(<code>Loyalty Tier = Gold</code>) = <strong>TRUE</strong>. (Even though he didn't make a big purchase).</li></ul>
                            </li>
                            <li>
                                <strong>Beth Smith (p-102):</strong> Matched.
                                <ul><li>(<code>Loyalty Tier = Gold</code>) = <strong>TRUE</strong>. (Even though she had *no events* at all).</li></ul>
                            </li>
                            <li>
                                <strong>Carlos Gomez (p-103):</strong> Matched.
                                <ul><li>(<code>Loyalty Tier = Gold</code>) = FALSE, <strong>BUT</strong> (<code>Purchase Value = 650</code>) = <strong>TRUE</strong>.</li></ul>
                            </li>
                            <li>
                                <strong>Name Unavailable (p-901):</strong> Matched.
                                <ul><li>This person was <strong>found only in the event data</strong> (a `Full Outer Join`).</li><li>(<code>Loyalty Tier = Gold</code>) = FALSE, <strong>BUT</strong> (<code>Purchase Value = 700</code>) = <strong>TRUE</strong>.</li></ul>
                            </li>
                        </ol>
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // --- Main Tab Navigation ---
    function openMainTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("main-tab-pane");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("main-tab-link");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    // --- Tab 3: Connection Setup ---
    function switchConnectionTab(evt, tabId) {
        document.querySelectorAll('.connection-pane').forEach(p => p.classList.add('d-none'));
        document.querySelectorAll('.connection-nav-item').forEach(i => i.classList.remove('active'));
        
        const pane = document.getElementById(tabId);
        if (pane) {
            pane.classList.remove('d-none');
        } else {
            console.error("Connection pane not found:", tabId);
        }
        
        if (evt && evt.currentTarget) {
            evt.currentTarget.classList.add('active');
        }
    }

    // --- Tab 4: Data View Config ---
    const dvState = {
        sourceComponents: {
            'total-people': { id: 'total-people', name: 'Total People', dataset: 'System', path: 'System-Generated (Profile-Only)', type: 'system', settings: { scope: 'Total Population (Profile-based)', behavior: 'Count Instances' } },
            'total-people-union': { id: 'total-people-union', name: 'Total People (Union)', dataset: 'System', path: 'System-Generated (Profile+Event)', type: 'system', settings: { scope: 'Total Population (Union)', behavior: 'Count Instances' } },
            'name': { id: 'name', name: 'Full Name', dataset: 'CRM Profiles', path: 'CRM Profiles', type: 'dim', settings: {} },
            'tier': { id: 'tier', name: 'Loyalty Tier', dataset: 'CRM Profiles', path: 'CRM Profiles', type: 'dim', settings: {} },
            'purchase-value': { id: 'purchase-value', name: 'Purchase Value', dataset: 'Web/Purchase Events', path: 'Web/Purchase Events', type: 'metric', settings: { scope: 'Event-based (Occurrences)', behavior: 'Sum' } }
        },
        includedComponents: [],
        selectedInstanceId: null,
        componentCounter: 0
    };

    function filterComponents(value) {
        const searchTerm = value.toLowerCase();
        document.querySelectorAll('.dv-component-item').forEach(item => {
            const name = item.getAttribute('data-name').toLowerCase();
            if (name.includes(searchTerm)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function toggleDvGroup(groupId) {
        document.querySelector(`.dv-dataset-group[data-group-id='${groupId}']`).classList.toggle('expanded');
    }

    function dvAddComponent(id, groupId) {
        const sourceComp = dvState.sourceComponents[id];
        if (!sourceComp) return;

        let path = sourceComp.path;
        
        dvState.componentCounter++;
        const instanceId = `${id}-${dvState.componentCounter}`;
        
        const newInstance = JSON.parse(JSON.stringify(sourceComp)); // deep copy
        newInstance.instanceId = instanceId;
        newInstance.path = path;

        dvState.includedComponents.push(newInstance);
        renderDataView();
        dvSelectComponent(instanceId);
    }

    function dvSelectComponent(id) {
        dvState.selectedInstanceId = id;
        renderDataView();
    }

    function dvSaveSettings() {
        const id = dvState.selectedInstanceId;
        if (!id) return;
        
        const comp = dvState.includedComponents.find(c => c.instanceId === id);
        if (!comp) return;

        comp.name = document.getElementById('setting-name').value;
        
        if(comp.type === 'metric' || comp.type === 'system') {
            // Special handling for the new "Union" scope
            if (document.getElementById('setting-scope')) {
                comp.settings.scope = document.getElementById('setting-scope').value;
            }
            if (document.getElementById('setting-behavior')) {
                comp.settings.behavior = document.getElementById('setting-behavior').value;
            }
        }
        
        dvState.selectedInstanceId = null; // Deselect after saving
        renderDataView();
        alert('Settings saved!');
    }

    function renderDataView() {
        // Render Middle Panel (Included)
        const tableBody = document.querySelector('#dv-included-table tbody');
        tableBody.innerHTML = '';
        dvState.includedComponents.forEach(comp => {
            const row = document.createElement('tr');
            row.onclick = () => dvSelectComponent(comp.instanceId);
            if (comp.instanceId === dvState.selectedInstanceId) {
                row.classList.add('selected');
            }
            
            let iconSvg = '';
            if(comp.type === 'metric') iconSvg = `<svg class="icon icon-metric"><use href="#icon-metric"></use></svg>`;
            else if(comp.type === 'dim') iconSvg = `<svg class="icon icon-dim"><use href="#icon-dim"></use></svg>`;
            else if(comp.type === 'system') iconSvg = `<svg class="icon icon-system"><use href="#icon-system"></use></svg>`;

            row.innerHTML = `
                <td>${iconSvg} <span class="component-name">${comp.name}</span></td>
                <td>${comp.dataset}</td>
                <td>${comp.path}</td>
            `;
            tableBody.appendChild(row);
        });

        // Render Right Panel (Settings)
        const placeholder = document.getElementById('dv-settings-placeholder');
        const settingsPanel = document.getElementById('dv-settings-panel');
        if (!dvState.selectedInstanceId) {
            placeholder.classList.remove('d-none');
            settingsPanel.classList.add('d-none');
            settingsPanel.innerHTML = '';
        } else {
            placeholder.classList.add('d-none');
            settingsPanel.classList.remove('d-none');
            
            const comp = dvState.includedComponents.find(c => c.instanceId === dvState.selectedInstanceId);
            if (!comp) return;

            let settingsHtml = `
                <div class="dv-right-panel-settings">
                    <h3>Component settings</h3>
                    <div class="form-group">
                        <label for="setting-name">NAME</label>
                        <input type="text" id="setting-name" value="${comp.name}">
                    </div>
            `;
            
            if(comp.type === 'metric' || comp.type === 'system') {
                const isSystem = comp.type === 'system';
                let scopeOptions = `
                    <option value="Event-based (Occurrences)" ${comp.settings.scope === 'Event-based (Occurrences)' ? 'selected' : ''}>Event-based (Occurrences)</option>
                    <option value="Total Population (Profile-based)" ${comp.settings.scope === 'Total Population (Profile-based)' ? 'selected' : ''}>Total Population (Profile-based)</option>
                `;
                
                // Add the Union scope option only for the Union metric
                if (comp.settings.scope === 'Total Population (Union)') {
                    scopeOptions += `<option value="Total Population (Union)" selected>Total Population (Union)</option>`;
                }

                settingsHtml += `
                    <div class="form-group">
                        <label for="setting-scope">SCOPE</label>
                        <select id="setting-scope" ${isSystem ? 'disabled' : ''}>
                           ${scopeOptions}
                        </select>
                        ${comp.type === 'metric' ? '<small style="color: #555; font-size: 13px;">Select "Total Population" to query all profiles, ignoring events.</small>' : ''}
                        ${isSystem ? `<div class="info-box" style="padding: 10px; font-size: 13px; margin-top: 10px;"><strong>System Metric:</strong> Scope is locked for system-generated TPR metrics. (${comp.settings.scope})</div>` : ''}
                    </div>
                    <div class="form-group">
                        <label for="setting-behavior">BEHAVIOR</label>
                        <select id="setting-behavior" ${isSystem ? 'disabled' : ''}>
                            <option value="Count Instances" ${comp.settings.behavior === 'Count Instances' ? 'selected' : ''}>Count Instances</option>
                            <option value="Sum" ${comp.settings.behavior === 'Sum' ? 'selected' : ''}>Sum</option>
                            <option value="Average" ${comp.settings.behavior === 'Average' ? 'selected' : ''}>Average</option>
                            <option value="Min" ${comp.settings.behavior === 'Min' ? 'selected' : ''}>Min</option>
                            <option value="Max" ${comp.settings.behavior === 'Max' ? 'selected' : ''}>Max</option>
                        </select>
                    </div>
                `;
            }

            settingsHtml += `
                    <button class="button button-primary" onclick="dvSaveSettings()">Save</button>
                </div>
            `;
            settingsPanel.innerHTML = settingsHtml;
        }
    }

    // Initial render
    document.addEventListener("DOMContentLoaded", function() {
        openMainTab({currentTarget: document.querySelector('.main-tab-link.active')}, 'tab-1');
        renderDataView();
    });
</script>

</body>
</html>
